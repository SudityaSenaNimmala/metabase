<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Auto-Clone Service</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for real charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-hover: #22222e;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2d2d3a;
            --glow-blue: rgba(59, 130, 246, 0.3);
            --glow-green: rgba(16, 185, 129, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Spin animation */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        /* Animated background */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(6, 182, 212, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .mongodb-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 100px;
            font-size: 0.85rem;
        }

        .mongodb-status .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .mongodb-status.connected .status-indicator {
            background: var(--accent-green);
            box-shadow: 0 0 8px var(--accent-green);
        }

        .mongodb-status.disconnected .status-indicator {
            background: var(--accent-red);
            box-shadow: 0 0 8px var(--accent-red);
        }

        .mongodb-status.connected {
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--accent-green);
        }

        .mongodb-status.disconnected {
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--accent-red);
        }

        /* Timer Section */
        .timer-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 3rem;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .timer-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan), var(--accent-purple));
        }

        .timer-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 1rem;
        }

        .timer-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 5rem;
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 0 0 60px var(--glow-blue);
            margin-bottom: 1.5rem;
            letter-spacing: 0.05em;
        }

        .timer-display.running {
            color: var(--accent-green);
            text-shadow: 0 0 60px var(--glow-green);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 100px;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .status-badge.running {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.active {
            background: var(--accent-green);
            animation: blink 1s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Action Buttons */
        .actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.75rem;
            border: none;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent-blue);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .stat-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .stat-card::after {
            content: 'Click to view â†’';
            position: absolute;
            bottom: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: var(--text-muted);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .stat-card:hover::after {
            opacity: 1;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-value.content { color: var(--accent-blue); }
        .stat-value.message { color: var(--accent-purple); }
        .stat-value.email { color: var(--accent-cyan); }
        .stat-value.total { color: var(--accent-green); }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Activity Log */
        .log-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            overflow: hidden;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .log-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .log-header h2::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple));
            border-radius: 2px;
        }

        .log-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-muted);
            background: var(--bg-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .log-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .log-list::-webkit-scrollbar {
            width: 8px;
        }

        .log-list::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .log-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .log-entry {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 1.5rem;
            align-items: center;
            padding: 1.25rem 2rem;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
        }

        .log-entry:hover {
            background: var(--bg-hover);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-type {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            letter-spacing: 0.05em;
        }

        .log-type.content {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
        }

        .log-type.message {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-purple);
        }

        .log-type.email {
            background: rgba(6, 182, 212, 0.15);
            color: var(--accent-cyan);
        }

        .log-info {
            min-width: 0;
        }

        .log-dashboard {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .log-database {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .log-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .log-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .status-icon.success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }

        .status-icon.failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .status-icon.deleted {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
        }

        .log-entry.deleted {
            opacity: 0.7;
            border-left: 3px solid #fbbf24;
        }

        .log-link {
            color: var(--accent-blue);
            text-decoration: none;
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .log-entry:hover .log-link {
            opacity: 1;
        }

        .log-link:hover {
            text-decoration: underline;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Log Filters - Compact Single Row */
        .log-filters {
            display: flex;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-divider {
            color: var(--border-color);
            margin: 0 0.25rem;
            font-size: 0.9rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .filter-btn {
            padding: 0.3rem 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .filter-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        /* Type-specific active colors */
        .filter-btn.type-content.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
        }

        .filter-btn.type-message.active {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
        }

        .filter-btn.type-email.active {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }

        /* Status-specific active colors */
        .filter-btn.status-success.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
        }

        .filter-btn.status-failed.active {
            background: #ef4444;
            border-color: #ef4444;
        }

        .filter-btn.status-deleted.active {
            background: #f59e0b;
            border-color: #f59e0b;
        }

        .date-picker-container {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .date-picker-container input[type="date"] {
            padding: 0.3rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .date-picker-container input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.7);
            cursor: pointer;
        }

        .date-picker-container input[type="date"]:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .clear-btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }

        /* Dashboards Modal Styles (Full Screen) */
        .dashboards-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 1001;
            animation: fadeIn 0.2s ease;
        }

        .dashboards-modal.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .dashboards-modal-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .dashboards-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
        }

        .dashboards-modal-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .dashboards-modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .dashboards-count {
            background: var(--bg-secondary);
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .dashboards-modal-close {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            font-size: 1rem;
            color: var(--text-primary);
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dashboards-modal-close:hover {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
        }

        .dashboards-modal-search {
            padding: 1rem 2rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
        }

        .dashboards-modal-search input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .dashboards-modal-search input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .dashboards-modal-search input::placeholder {
            color: var(--text-muted);
        }

        .dashboards-modal-body {
            padding: 1.5rem 2rem;
            overflow-y: auto;
            flex: 1;
            background: var(--bg-primary);
        }

        /* Dashboard Cards Grid */
        #dashboards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .dashboard-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .dashboard-card:hover {
            border-color: var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            opacity: 1;
        }

        .dashboard-card.type-content::before { background: var(--accent-green); }
        .dashboard-card.type-message::before { background: var(--accent-purple); }
        .dashboard-card.type-email::before { background: var(--accent-orange); }

        .dashboard-card-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .dashboard-card-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 0.75rem;
            min-height: 2.4em;
        }

        .dashboard-card-footer {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .dashboard-card-id {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .dashboard-card-type {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .dashboard-card-type.content {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .dashboard-card-type.message {
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent-purple);
        }

        .dashboard-card-type.email {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-orange);
        }

        .dashboard-open-btn {
            margin-left: auto;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.75rem;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dashboard-open-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .dashboard-open-btn svg {
            flex-shrink: 0;
        }

        .loading-spinner {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
            grid-column: 1 / -1;
        }

        .no-results {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
            grid-column: 1 / -1;
        }

        /* Dashboard Selection for Merge */
        .dashboard-select-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .dashboard-select-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            transform: scale(1.1);
        }

        .dashboard-select-btn.selected {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .dashboard-select-btn svg {
            width: 14px;
            height: 14px;
        }

        .dashboard-card {
            position: relative;
        }

        /* Dashboard Card Flip Animation for Update */
        .dashboard-card-container {
            perspective: 1000px;
            position: relative;
        }

        .dashboard-card-inner {
            position: relative;
            width: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .dashboard-card-container.flipped .dashboard-card-inner {
            transform: rotateY(180deg);
        }

        .dashboard-card-front,
        .dashboard-card-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        .dashboard-card-front {
            position: relative;
        }

        .dashboard-card-back {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotateY(180deg);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            box-sizing: border-box;
        }

        .update-progress-container {
            width: 100%;
            text-align: center;
            display: none;
        }

        .update-progress-container.active {
            display: block;
        }

        .update-progress-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .update-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .update-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .update-progress-status {
            font-size: 0.8rem;
            color: var(--text-muted);
            min-height: 1.5em;
            margin-bottom: 1rem;
        }

        .update-progress-status.success {
            color: var(--accent-green);
        }

        .update-progress-status.error {
            color: var(--accent-red);
        }

        .update-cancel-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            background: transparent;
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .update-cancel-btn:hover {
            background: var(--accent-red);
            color: white;
        }

        .update-cancel-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .update-cancel-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Update Confirmation View */
        .update-confirm-container {
            width: 100%;
            text-align: center;
            display: none;
        }

        .update-confirm-container.active {
            display: block;
        }

        .update-confirm-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .update-confirm-message {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 1.25rem;
            line-height: 1.5;
        }

        .update-confirm-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
        }

        .update-confirm-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .update-confirm-btn.proceed {
            background: var(--accent-blue);
            color: white;
            border: none;
        }

        .update-confirm-btn.proceed:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .update-confirm-btn.cancel {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        .update-confirm-btn.cancel:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        /* Edit Name View */
        .edit-name-container {
            width: 100%;
            text-align: center;
            display: none;
        }

        .edit-name-container.active {
            display: block;
        }

        .edit-name-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .edit-name-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .edit-name-input:focus {
            border-color: var(--accent-blue);
        }

        .edit-name-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
        }

        /* Update Button */
        .dashboard-update-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.75rem;
            background: transparent;
            color: var(--accent-orange);
            border: 1px solid var(--accent-orange);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dashboard-update-btn:hover {
            background: var(--accent-orange);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .dashboard-update-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .dashboard-update-btn svg {
            flex-shrink: 0;
        }

        /* Icon Action Buttons Container */
        .dashboard-icon-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 8px;
        }

        /* Delete Button - Simple Icon */
        .dashboard-delete-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            padding: 0;
            background: transparent;
            color: var(--text-muted);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .dashboard-delete-btn:hover {
            color: var(--accent-red);
            opacity: 1;
            transform: scale(1.1);
        }

        .dashboard-delete-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .dashboard-delete-btn svg {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
        }

        /* Edit Button - Simple Icon */
        .dashboard-edit-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            padding: 0;
            background: transparent;
            color: var(--text-muted);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .dashboard-edit-btn:hover {
            color: var(--accent-blue);
            opacity: 1;
            transform: scale(1.1);
        }

        .dashboard-edit-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .dashboard-edit-btn svg {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
        }

        /* Update Button - Simple Icon */
        .dashboard-update-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            padding: 0;
            background: transparent;
            color: var(--text-muted);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .dashboard-update-btn:hover {
            color: var(--accent-orange);
            opacity: 1;
            transform: scale(1.1);
        }

        .dashboard-update-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .dashboard-update-btn svg {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
        }

        .dashboard-card.selected {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        /* Merge Toolbar */
        .merge-toolbar {
            display: none;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-blue);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .merge-toolbar.active {
            display: flex;
        }

        .merge-toolbar-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-primary);
        }

        .merge-toolbar-count {
            background: var(--accent-blue);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .merge-toolbar-input {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .merge-toolbar-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .merge-toolbar-input::placeholder {
            color: var(--text-muted);
        }

        .merge-toolbar-actions {
            display: flex;
            gap: 0.5rem;
        }

        .merge-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .merge-btn-primary {
            background: var(--accent-green);
            color: white;
            border: none;
        }

        .merge-btn-primary:hover {
            background: #059669;
        }

        .merge-btn-primary:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }

        .merge-btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .merge-btn-secondary:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        /* Merged Dashboards Section */
        .merged-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .merged-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .merged-section-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .merged-section-header h2 svg {
            width: 20px;
            height: 20px;
            color: var(--accent-purple);
        }

        .merged-count {
            background: var(--bg-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .merged-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .merged-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .merged-item:hover {
            background: var(--bg-hover);
        }

        .merged-item-info {
            flex: 1;
        }

        .merged-item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .merged-item-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .merged-item-type {
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .merged-item-type.content {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .merged-item-type.message {
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent-purple);
        }

        .merged-item-type.email {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-orange);
        }

        .merged-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .merged-item-btn {
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .merged-item-btn.view {
            background: var(--accent-blue);
            color: white;
            border: none;
        }

        .merged-item-btn.view:hover {
            background: #2563eb;
        }

        .merged-item-btn.delete {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        .merged-item-btn.delete:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .merged-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        /* Merged Dashboard Viewer Modal */
        .merged-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 10000;
            display: none;
            flex-direction: column;
        }

        .merged-viewer-modal.active {
            display: flex;
        }

        .merged-viewer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
        }

        .merged-viewer-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .merged-viewer-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .merged-viewer-close {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .merged-viewer-close:hover {
            border-color: var(--accent-blue);
        }

        .merged-viewer-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .merged-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .merged-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            min-height: 200px;
        }

        .merged-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .merged-card-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .merged-card-type {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .merged-card-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent-blue);
            text-align: center;
            padding: 1rem 0;
        }

        .merged-card-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .merged-card-table th {
            text-align: left;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-muted);
            font-weight: 600;
        }

        .merged-card-table td {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .merged-card-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 150px;
            color: var(--text-muted);
        }

        /* Config Section */
        .config-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .config-item {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
        }

        .config-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .config-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .config-value.not-set {
            color: var(--accent-red);
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-section h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-section h3 svg {
            width: 16px;
            height: 16px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px var(--glow-blue);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .form-row .form-group {
            margin-bottom: 0;
        }

        .modal-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 0 0 16px 16px;
        }

        .test-btn {
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .test-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .save-btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px var(--glow-blue);
        }

        .save-btn:disabled, .test-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--accent-green);
        }

        .toast.error {
            background: var(--accent-red);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .timer-display {
                font-size: 3rem;
            }

            .log-entry {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-footer {
                flex-direction: column;
                gap: 1rem;
            }

            .modal-footer button {
                width: 100%;
                justify-content: center;
            }
        }

        /* =================================================================
           LOGIN PAGE STYLES
           ================================================================= */
        
        .login-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 3rem;
            max-width: 420px;
            width: 90%;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan), var(--accent-purple));
        }

        .login-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-logo svg {
            width: 40px;
            height: 40px;
            stroke: white;
        }

        .login-title {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 2rem;
        }

        .login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
            padding: 1rem 1.5rem;
            background: #2f2f2f;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .login-btn:hover {
            background: #3a3a3a;
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .login-btn svg {
            width: 20px;
            height: 20px;
        }

        .login-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            color: var(--accent-red);
            font-size: 0.9rem;
        }

        .login-domain-note {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .login-domain-note strong {
            color: var(--text-secondary);
        }

        /* =================================================================
           USER MENU STYLES
           ================================================================= */
        
        .user-menu {
            position: absolute;
            top: 1rem;
            right: 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-info:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            color: white;
        }

        .user-name {
            font-size: 0.9rem;
            color: var(--text-primary);
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            min-width: 200px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .user-info.active + .user-dropdown,
        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .user-dropdown-email {
            font-size: 0.85rem;
            color: var(--text-secondary);
            word-break: break-all;
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .user-dropdown-item:hover {
            background: var(--bg-hover);
        }

        .user-dropdown-item.logout {
            color: var(--accent-red);
            border-top: 1px solid var(--border-color);
        }

        .user-dropdown-item svg {
            width: 16px;
            height: 16px;
        }

        /* Hide main content when not authenticated */
        .main-content.hidden {
            display: none;
        }

        .login-page.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <!-- Login Page (shown when not authenticated) -->
    <div id="login-page" class="login-page">
        <div class="login-container">
            <div class="login-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="3" y1="9" x2="21" y2="9"></line>
                    <line x1="9" y1="21" x2="9" y2="9"></line>
                </svg>
            </div>
            <h1 class="login-title">Dashboard Service</h1>
            <p class="login-subtitle">Sign in to access the dashboard management tool</p>
            
            <div id="login-error" class="login-error" style="display: none;"></div>
            
            <button class="login-btn" onclick="startLogin()">
                <svg viewBox="0 0 23 23" fill="none">
                    <path fill="#f3f3f3" d="M0 0h11v11H0z"/>
                    <path fill="#f35325" d="M0 0h11v11H0z"/>
                    <path fill="#81bc06" d="M12 0h11v11H12z"/>
                    <path fill="#05a6f0" d="M0 12h11v11H0z"/>
                    <path fill="#ffba08" d="M12 12h11v11H12z"/>
                </svg>
                Sign in with Microsoft
            </button>
            
            <div class="login-domain-note" id="login-domain-note" style="display: none;">
                <strong>Note:</strong> Only <span id="allowed-domain"></span> accounts are allowed.
            </div>
        </div>
    </div>
    
    <!-- Main Content (shown when authenticated) -->
    <div id="main-content" class="main-content hidden">
    <div class="container">
        <!-- User Menu -->
        <div class="user-menu">
            <div class="user-info" id="user-info" onclick="toggleUserDropdown()">
                <div class="user-avatar" id="user-avatar">?</div>
                <span class="user-name" id="user-name">Loading...</span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>
            <div class="user-dropdown" id="user-dropdown">
                <div class="user-dropdown-header">
                    <div class="user-dropdown-email" id="user-email">user@example.com</div>
                </div>
                <div class="user-dropdown-item logout" onclick="logout()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Sign Out
                </div>
            </div>
        </div>
        
        <header class="header">
            <h1>Dashboard Auto-Clone Service</h1>
            <p>Automatically creates dashboards for new databases every 4 hours</p>
            <div class="mongodb-status" id="mongodb-status" style="margin-top: 0.75rem;">
                <span class="status-indicator" id="mongodb-indicator"></span>
                <span id="mongodb-text">Checking MongoDB...</span>
            </div>
        </header>

        <!-- Timer Section -->
        <section class="timer-section">
            <div class="timer-label">Next Check In</div>
            <div class="timer-display" id="countdown">--:--:--</div>
            <div class="status-badge" id="status-badge">
                <span class="status-dot" id="status-dot"></span>
                <span id="status-text">Loading...</span>
            </div>
            <div class="actions">
                <button class="btn btn-primary" id="run-btn" onclick="triggerRun()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    Run Now
                </button>
                <button class="btn btn-danger" id="stop-btn" onclick="stopRun()" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                    </svg>
                    Stop
                </button>
                <button class="btn btn-secondary" onclick="refreshData()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    Refresh
                </button>
                <button class="btn btn-secondary" onclick="openSettings()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Settings
                </button>
            </div>
        </section>

        <!-- Stats Grid -->
        <section class="stats-grid">
            <div class="stat-card" onclick="openDashboardsModal('all')" style="cursor: pointer;" title="Click to view all dashboards">
                <div class="stat-value total" id="stat-total">-</div>
                <div class="stat-label">Total Dashboards</div>
            </div>
            <div class="stat-card" onclick="openDashboardsModal('content')" style="cursor: pointer;" title="Click to view Content dashboards">
                <div class="stat-value content" id="stat-content">-</div>
                <div class="stat-label">Content</div>
            </div>
            <div class="stat-card" onclick="openDashboardsModal('message')" style="cursor: pointer;" title="Click to view Message dashboards">
                <div class="stat-value message" id="stat-message">-</div>
                <div class="stat-label">Message</div>
            </div>
            <div class="stat-card" onclick="openDashboardsModal('email')" style="cursor: pointer;" title="Click to view Email dashboards">
                <div class="stat-value email" id="stat-email">-</div>
                <div class="stat-label">Email</div>
            </div>
        </section>

        <!-- Dashboards Modal (Full Screen) -->
        <div id="dashboards-modal" class="dashboards-modal">
            <div class="dashboards-modal-content">
                <div class="dashboards-modal-header">
                    <div class="dashboards-modal-header-left">
                        <h2 id="modal-title">Dashboards</h2>
                        <span class="dashboards-count" id="dashboards-count">0 dashboards</span>
                    </div>
                    <button class="dashboards-modal-close" onclick="closeDashboardsModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Back to Dashboard
                    </button>
                </div>
                
                <!-- Merge Toolbar -->
                <div id="merge-toolbar" class="merge-toolbar">
                    <div class="merge-toolbar-info">
                        <span class="merge-toolbar-count" id="merge-count">0</span>
                        <span>dashboards selected for merge</span>
                    </div>
                    <input type="text" class="merge-toolbar-input" id="merge-name-input" placeholder="Enter merged dashboard name...">
                    <div class="merge-toolbar-actions">
                        <button class="merge-btn merge-btn-secondary" onclick="clearMergeSelection()">
                            Clear
                        </button>
                        <button class="merge-btn merge-btn-primary" id="create-merge-btn" onclick="createMergedDashboard()" disabled>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            Create Merged Dashboard
                        </button>
                    </div>
                </div>
                
                <div class="dashboards-modal-search">
                    <input type="text" id="dashboard-search" placeholder="Search dashboards by name, description, or ID..." oninput="filterDashboardCards()">
                </div>
                <div class="dashboards-modal-body">
                    <div id="dashboards-grid">
                        <div class="loading-spinner">Loading dashboards...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Merged Dashboards Section -->
        <section class="merged-section">
            <div class="merged-section-header">
                <h2>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Merged Dashboards
                </h2>
                <span class="merged-count" id="merged-count">0 merged</span>
            </div>
            <div class="merged-list" id="merged-list">
                <div class="merged-empty">
                    <p>No merged dashboards yet</p>
                    <p style="font-size: 0.85rem; margin-top: 0.5rem;">Click on dashboard cards and use the + button to select dashboards for merging</p>
                </div>
            </div>
        </section>

        <!-- Config Section -->
        <section class="config-section">
            <div class="config-grid">
                <div class="config-item">
                    <div class="config-label">Content Dashboard</div>
                    <div class="config-value" id="config-content">Loading...</div>
                </div>
                <div class="config-item">
                    <div class="config-label">Message Dashboard</div>
                    <div class="config-value" id="config-message">Loading...</div>
                </div>
                <div class="config-item">
                    <div class="config-label">Email Dashboard</div>
                    <div class="config-value" id="config-email">Loading...</div>
                </div>
            </div>
        </section>

        <!-- Activity Log -->
        <section class="log-section">
            <div class="log-header">
                <h2>Activity Log</h2>
                <span class="log-count" id="log-count">0 entries</span>
            </div>
            
            <!-- Compact Filters -->
            <div class="log-filters">
                <!-- Row 1: Time filters + Date picker -->
                <div class="filter-row">
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="time" data-value="all" onclick="setTimeFilter('all')">All</button>
                        <button class="filter-btn" data-filter="time" data-value="1hour" onclick="setTimeFilter('1hour')">1h</button>
                        <button class="filter-btn" data-filter="time" data-value="today" onclick="setTimeFilter('today')">Today</button>
                        <button class="filter-btn" data-filter="time" data-value="7days" onclick="setTimeFilter('7days')">7d</button>
                        <button class="filter-btn" data-filter="time" data-value="month" onclick="setTimeFilter('month')">Month</button>
                        <button class="filter-btn" data-filter="time" data-value="year" onclick="setTimeFilter('year')">Year</button>
                    </div>
                    <span class="filter-divider">|</span>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="type" data-value="all" onclick="toggleTypeFilter('all')">All</button>
                        <button class="filter-btn type-content" data-filter="type" data-value="content" onclick="toggleTypeFilter('content')">Content</button>
                        <button class="filter-btn type-message" data-filter="type" data-value="message" onclick="toggleTypeFilter('message')">Message</button>
                        <button class="filter-btn type-email" data-filter="type" data-value="email" onclick="toggleTypeFilter('email')">Email</button>
                    </div>
                    <span class="filter-divider">|</span>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="status" data-value="all" onclick="toggleStatusFilter('all')">All</button>
                        <button class="filter-btn status-success" data-filter="status" data-value="success" onclick="toggleStatusFilter('success')">Success</button>
                        <button class="filter-btn status-failed" data-filter="status" data-value="failed" onclick="toggleStatusFilter('failed')">Failed</button>
                        <button class="filter-btn status-deleted" data-filter="status" data-value="deleted" onclick="toggleStatusFilter('deleted')">Deleted</button>
                    </div>
                    <span class="filter-divider">|</span>
                    <div class="date-picker-container">
                        <input type="date" id="date-picker" onchange="filterByDate(this.value)">
                        <button class="filter-btn clear-btn" onclick="clearAllFilters()">Reset</button>
                    </div>
                </div>
            </div>
            
            <div class="log-list" id="log-list">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <p>No dashboards created yet</p>
                    <p style="font-size: 0.85rem; margin-top: 0.5rem;">Dashboards will appear here when created</p>
                </div>
            </div>
        </section>
    </div>

    <script>
        let countdownInterval;
        let secondsRemaining = 0;
        let allLogEntries = [];  // Store all entries for filtering
        let selectedDate = null;
        let currentUser = null;  // Current authenticated user
        let userDropdownOpen = false;
        
        // Dashboard merge selection state
        let selectedDashboards = new Map();  // Map of id -> dashboard object
        let mergedDashboardsList = [];  // List of merged dashboards
        
        // Multi-select filter state
        let filters = {
            time: 'all',           // Single select: all, 1hour, today, 7days, month, year
            types: new Set(),      // Multi-select: content, message, email
            statuses: new Set()    // Multi-select: success, failed, deleted
        };

        // =================================================================
        // AUTHENTICATION FUNCTIONS
        // =================================================================
        
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                
                if (!data.auth_configured) {
                    // Auth not configured - show main content without login
                    showMainContent();
                    return;
                }
                
                // Show allowed domain note on login page
                if (data.allowed_domain) {
                    document.getElementById('login-domain-note').style.display = 'block';
                    document.getElementById('allowed-domain').textContent = '@' + data.allowed_domain;
                }
                
                if (data.authenticated && data.user) {
                    currentUser = data.user;
                    showMainContent();
                    updateUserMenu();
                } else {
                    showLoginPage();
                    checkLoginError();
                }
            } catch (error) {
                console.error('Auth status check failed:', error);
                // On error, show main content (fail open for development)
                showMainContent();
            }
        }
        
        function checkLoginError() {
            // Check URL for error parameters
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            
            if (error) {
                const errorDiv = document.getElementById('login-error');
                let errorMessage = 'Login failed. Please try again.';
                
                switch (error) {
                    case 'domain_not_allowed':
                        const domain = urlParams.get('domain');
                        errorMessage = `Access denied. The domain @${domain} is not allowed.`;
                        break;
                    case 'no_email':
                        errorMessage = 'Could not retrieve email from your account.';
                        break;
                    case 'oauth_not_configured':
                        errorMessage = 'OAuth is not configured on the server.';
                        break;
                    case 'session_creation_failed':
                        errorMessage = 'Failed to create session. Please try again.';
                        break;
                    case 'callback_failed':
                        errorMessage = 'Authentication callback failed. Please try again.';
                        break;
                }
                
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        function showLoginPage() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
        }
        
        function showMainContent() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        }
        
        async function startLogin() {
            try {
                const response = await fetch('/api/auth/login');
                const data = await response.json();
                
                if (data.auth_url) {
                    window.location.href = data.auth_url;
                } else if (data.error) {
                    const errorDiv = document.getElementById('login-error');
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Login failed:', error);
                const errorDiv = document.getElementById('login-error');
                errorDiv.textContent = 'Failed to start login. Please try again.';
                errorDiv.style.display = 'block';
            }
        }
        
        function updateUserMenu() {
            if (!currentUser) return;
            
            // Set avatar initials
            const initials = (currentUser.name || currentUser.email || '?')
                .split(' ')
                .map(n => n[0])
                .join('')
                .substring(0, 2)
                .toUpperCase();
            document.getElementById('user-avatar').textContent = initials;
            
            // Set name
            document.getElementById('user-name').textContent = currentUser.name || currentUser.email;
            
            // Set email in dropdown
            document.getElementById('user-email').textContent = currentUser.email;
        }
        
        function toggleUserDropdown() {
            userDropdownOpen = !userDropdownOpen;
            const dropdown = document.getElementById('user-dropdown');
            const userInfo = document.getElementById('user-info');
            
            if (userDropdownOpen) {
                dropdown.classList.add('show');
                userInfo.classList.add('active');
            } else {
                dropdown.classList.remove('show');
                userInfo.classList.remove('active');
            }
        }
        
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                currentUser = null;
                showLoginPage();
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const userMenu = document.querySelector('.user-menu');
            if (userMenu && !userMenu.contains(e.target) && userDropdownOpen) {
                toggleUserDropdown();
            }
        });

        // Format seconds to HH:MM:SS
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // Format timestamp - exact date and time in 24h format with seconds
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            // Format: YYYY-MM-DD HH:MM:SS
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // Filter entries by all criteria
        function filterEntries(entries) {
            return entries.filter(entry => {
                // Time filter
                if (!passesTimeFilter(entry)) return false;
                
                // Type filter (multi-select)
                if (filters.types.size > 0 && !filters.types.has(entry.db_type)) return false;
                
                // Status filter (multi-select)
                if (filters.statuses.size > 0 && !filters.statuses.has(entry.status)) return false;
                
                return true;
            });
        }

        // Check if entry passes time filter
        function passesTimeFilter(entry) {
            if (selectedDate) {
                const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                return entryDate === selectedDate;
            }
            
            const now = new Date();
            const entryDate = new Date(entry.timestamp);
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (filters.time) {
                case '1hour':
                    const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
                    return entryDate >= oneHourAgo;
                case 'today':
                    return entryDate >= today;
                case '7days':
                    const sevenDaysAgo = new Date(today);
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    return entryDate >= sevenDaysAgo;
                case 'month':
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    return entryDate >= startOfMonth;
                case 'year':
                    const startOfYear = new Date(now.getFullYear(), 0, 1);
                    return entryDate >= startOfYear;
                default:
                    return true;
            }
        }

        // Set time filter (single select)
        function setTimeFilter(value) {
            filters.time = value;
            selectedDate = null;
            document.getElementById('date-picker').value = '';
            
            // Update active button for time filter
            document.querySelectorAll('.filter-btn[data-filter="time"]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === value);
            });
            
            renderLogs();
        }

        // Toggle type filter (multi-select)
        function toggleTypeFilter(value) {
            if (value === 'all') {
                filters.types.clear();
                document.querySelectorAll('.filter-btn[data-filter="type"]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === 'all');
                });
            } else {
                // Remove 'all' active state
                document.querySelector('.filter-btn[data-filter="type"][data-value="all"]').classList.remove('active');
                
                // Toggle the specific type
                if (filters.types.has(value)) {
                    filters.types.delete(value);
                } else {
                    filters.types.add(value);
                }
                
                // Update button state
                document.querySelectorAll('.filter-btn[data-filter="type"]').forEach(btn => {
                    if (btn.dataset.value === 'all') {
                        btn.classList.toggle('active', filters.types.size === 0);
                    } else {
                        btn.classList.toggle('active', filters.types.has(btn.dataset.value));
                    }
                });
            }
            
            renderLogs();
        }

        // Toggle status filter (multi-select)
        function toggleStatusFilter(value) {
            if (value === 'all') {
                filters.statuses.clear();
                document.querySelectorAll('.filter-btn[data-filter="status"]').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === 'all');
                });
            } else {
                // Remove 'all' active state
                document.querySelector('.filter-btn[data-filter="status"][data-value="all"]').classList.remove('active');
                
                // Toggle the specific status
                if (filters.statuses.has(value)) {
                    filters.statuses.delete(value);
                } else {
                    filters.statuses.add(value);
                }
                
                // Update button state
                document.querySelectorAll('.filter-btn[data-filter="status"]').forEach(btn => {
                    if (btn.dataset.value === 'all') {
                        btn.classList.toggle('active', filters.statuses.size === 0);
                    } else {
                        btn.classList.toggle('active', filters.statuses.has(btn.dataset.value));
                    }
                });
            }
            
            renderLogs();
        }

        // Filter by specific date from date picker
        function filterByDate(dateValue) {
            if (dateValue) {
                selectedDate = dateValue;
                
                // Remove active from time filter buttons
                document.querySelectorAll('.filter-btn[data-filter="time"]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                renderLogs();
            }
        }

        // Clear all filters
        function clearAllFilters() {
            selectedDate = null;
            document.getElementById('date-picker').value = '';
            filters.time = 'all';
            filters.types.clear();
            filters.statuses.clear();
            
            // Reset all filter buttons
            document.querySelectorAll('.filter-btn[data-filter="time"]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === 'all');
            });
            document.querySelectorAll('.filter-btn[data-filter="type"]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === 'all');
            });
            document.querySelectorAll('.filter-btn[data-filter="status"]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === 'all');
            });
            
            renderLogs();
        }

        // ========== DASHBOARD MODAL FUNCTIONS ==========
        let allDashboardsData = { content: [], message: [], email: [] };
        let currentModalType = 'all';

        // Open dashboards modal
        async function openDashboardsModal(type) {
            currentModalType = type;
            const modal = document.getElementById('dashboards-modal');
            const grid = document.getElementById('dashboards-grid');
            const title = document.getElementById('modal-title');
            const searchInput = document.getElementById('dashboard-search');
            
            // Set title based on type
            const titles = {
                'all': 'All Dashboards',
                'content': 'Content Dashboards',
                'message': 'Message Dashboards',
                'email': 'Email Dashboards'
            };
            title.textContent = titles[type] || 'Dashboards';
            
            // Show modal with loading state
            modal.classList.add('active');
            grid.innerHTML = '<div class="loading-spinner">Loading dashboards...</div>';
            searchInput.value = '';
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
            
            try {
                if (type === 'all') {
                    // Fetch all types in parallel
                    const [contentRes, messageRes, emailRes] = await Promise.all([
                        fetch('/api/dashboards/content'),
                        fetch('/api/dashboards/message'),
                        fetch('/api/dashboards/email')
                    ]);
                    
                    const contentData = await contentRes.json();
                    const messageData = await messageRes.json();
                    const emailData = await emailRes.json();
                    
                    allDashboardsData.content = (contentData.dashboards || []).map(d => ({...d, type: 'content'}));
                    allDashboardsData.message = (messageData.dashboards || []).map(d => ({...d, type: 'message'}));
                    allDashboardsData.email = (emailData.dashboards || []).map(d => ({...d, type: 'email'}));
                    
                    renderDashboardCards([...allDashboardsData.content, ...allDashboardsData.message, ...allDashboardsData.email]);
                } else {
                    const response = await fetch(`/api/dashboards/${type}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        grid.innerHTML = `<div class="no-results">Error: ${data.error}</div>`;
                        return;
                    }
                    
                    allDashboardsData[type] = (data.dashboards || []).map(d => ({...d, type: type}));
                    renderDashboardCards(allDashboardsData[type]);
                }
            } catch (error) {
                grid.innerHTML = `<div class="no-results">Failed to load dashboards: ${error.message}</div>`;
            }
        }

        // Close dashboards modal
        function closeDashboardsModal() {
            const modal = document.getElementById('dashboards-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Refresh/fetch all dashboards data (used after update)
        async function fetchAllDashboards() {
            const grid = document.getElementById('dashboards-grid');
            
            try {
                // Fetch fresh data from all types
                const [contentRes, messageRes, emailRes] = await Promise.all([
                    fetch('/api/dashboards/content'),
                    fetch('/api/dashboards/message'),
                    fetch('/api/dashboards/email')
                ]);
                
                const contentData = await contentRes.json();
                const messageData = await messageRes.json();
                const emailData = await emailRes.json();
                
                // Update the cached data
                allDashboardsData.content = (contentData.dashboards || []).map(d => ({...d, type: 'content'}));
                allDashboardsData.message = (messageData.dashboards || []).map(d => ({...d, type: 'message'}));
                allDashboardsData.email = (emailData.dashboards || []).map(d => ({...d, type: 'email'}));
                
                // Re-render based on current modal type
                if (currentModalType === 'all') {
                    renderDashboardCards([...allDashboardsData.content, ...allDashboardsData.message, ...allDashboardsData.email]);
                } else {
                    renderDashboardCards(allDashboardsData[currentModalType] || []);
                }
                
                console.log('Dashboard data refreshed successfully');
            } catch (error) {
                console.error('Failed to refresh dashboards:', error);
                if (grid) {
                    grid.innerHTML = `<div class="no-results">Failed to refresh: ${error.message}</div>`;
                }
            }
        }

        // Render dashboard cards
        function renderDashboardCards(dashboards) {
            const grid = document.getElementById('dashboards-grid');
            const countEl = document.getElementById('dashboards-count');
            
            if (!dashboards || dashboards.length === 0) {
                grid.innerHTML = '<div class="no-results">No dashboards found</div>';
                countEl.textContent = '0 dashboards';
                return;
            }
            
            // Update count
            countEl.textContent = `${dashboards.length} dashboard${dashboards.length !== 1 ? 's' : ''}`;
            
            // Sort by name
            dashboards.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            
            grid.innerHTML = dashboards.map(d => {
                const isSelected = selectedDashboards.has(d.id);
                const selectedClass = isSelected ? 'selected' : '';
                const btnSelectedClass = isSelected ? 'selected' : '';
                const btnIcon = isSelected 
                    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                    : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>';
                
                return `
                <div class="dashboard-card-container" data-dashboard-id="${d.id}" data-dashboard-type="${d.type}">
                    <div class="dashboard-card-inner">
                        <!-- Front of card -->
                        <div class="dashboard-card-front">
                            <div class="dashboard-card type-${d.type} ${selectedClass}" data-id="${d.id}">
                                <button class="dashboard-select-btn ${btnSelectedClass}" onclick="toggleDashboardSelection(${d.id}, '${escapeHtml(d.name || 'Unnamed')}', '${d.type}', '${d.url}')" title="${isSelected ? 'Remove from selection' : 'Add to merge'}">
                                    ${btnIcon}
                                </button>
                                <div class="dashboard-card-name">${escapeHtml(d.name || 'Unnamed Dashboard')}</div>
                                <div class="dashboard-card-desc">${escapeHtml(d.description || 'No description')}</div>
                                <div class="dashboard-card-footer">
                                    <span class="dashboard-card-id">ID: ${d.id}</span>
                                    <span class="dashboard-card-type ${d.type}">${d.type}</span>
                                    <div class="dashboard-icon-actions">
                                        <button class="dashboard-edit-btn" onclick="editDashboard(${d.id}, '${d.type}', '${escapeHtml(d.name || 'Unnamed')}')" title="Edit name">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                            </svg>
                                        </button>
                                        <button class="dashboard-delete-btn" onclick="deleteDashboard(${d.id}, '${d.type}', '${escapeHtml(d.name || 'Unnamed')}')" title="Delete">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                                <line x1="14" y1="11" x2="14" y2="17"></line>
                                            </svg>
                                        </button>
                                        <button class="dashboard-update-btn" onclick="updateDashboard(${d.id}, '${d.type}', '${escapeHtml(d.name || 'Unnamed')}')" title="Update">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M23 4v6h-6"></path>
                                                <path d="M1 20v-6h6"></path>
                                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <button class="dashboard-open-btn" onclick="openDashboard('${d.url}')">
                                        Open
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                            <polyline points="15 3 21 3 21 9"></polyline>
                                            <line x1="10" y1="14" x2="21" y2="3"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Back of card (confirmation + progress) -->
                        <div class="dashboard-card-back">
                            <!-- Update Confirmation View -->
                            <div class="update-confirm-container active" id="confirm-view-${d.id}">
                                <div class="update-confirm-title">Update Dashboard?</div>
                                <div class="update-confirm-message">
                                    This will re-clone from the source template to get the latest changes.<br>
                                    Your current dashboard remains safe until the new one is ready.
                                </div>
                                <div class="update-confirm-buttons">
                                    <button class="update-confirm-btn cancel" onclick="cancelUpdateConfirm(${d.id})">
                                        Cancel
                                    </button>
                                    <button class="update-confirm-btn proceed" onclick="proceedWithUpdate(${d.id}, '${d.type}', '${escapeHtml(d.name || 'Unnamed')}')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M23 4v6h-6"></path>
                                            <path d="M1 20v-6h6"></path>
                                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                        </svg>
                                        Proceed
                                    </button>
                                </div>
                            </div>
                            <!-- Delete Confirmation View -->
                            <div class="update-confirm-container" id="delete-confirm-view-${d.id}">
                                <div class="update-confirm-title" style="color: var(--accent-red);">Delete Dashboard?</div>
                                <div class="update-confirm-message">
                                    This will permanently delete the dashboard and all its questions from Metabase.<br>
                                    <strong style="color: var(--accent-red);">This action cannot be undone.</strong>
                                </div>
                                <div class="update-confirm-buttons">
                                    <button class="update-confirm-btn cancel" onclick="cancelDeleteConfirm(${d.id})">
                                        Cancel
                                    </button>
                                    <button class="update-confirm-btn proceed" style="background: var(--accent-red); border-color: var(--accent-red);" onclick="proceedWithDelete(${d.id}, '${d.type}', '${escapeHtml(d.name || 'Unnamed')}')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        </svg>
                                        Delete
                                    </button>
                                </div>
                            </div>
                            <!-- Edit Name View -->
                            <div class="edit-name-container" id="edit-view-${d.id}">
                                <div class="edit-name-title">Edit Dashboard Name</div>
                                <input type="text" class="edit-name-input" id="edit-input-${d.id}" value="${escapeHtml(d.name || 'Unnamed Dashboard')}" placeholder="Dashboard name">
                                <div class="edit-name-buttons">
                                    <button class="update-confirm-btn cancel" onclick="cancelEditName(${d.id})">
                                        Cancel
                                    </button>
                                    <button class="update-confirm-btn proceed" onclick="saveEditName(${d.id}, '${d.type}')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                        Save
                                    </button>
                                </div>
                            </div>
                            <!-- Progress View -->
                            <div class="update-progress-container" id="progress-view-${d.id}">
                                <div class="update-progress-title">Updating Dashboard</div>
                                <div class="update-progress-bar">
                                    <div class="update-progress-fill" id="progress-fill-${d.id}"></div>
                                </div>
                                <div class="update-progress-status" id="progress-status-${d.id}">Initializing...</div>
                                <button class="update-cancel-btn" id="cancel-btn-${d.id}" onclick="cancelDashboardUpdate(${d.id})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                    Cancel Update
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Filter dashboard cards by search
        function filterDashboardCards() {
            const searchTerm = document.getElementById('dashboard-search').value.toLowerCase().trim();
            
            let dashboards = [];
            if (currentModalType === 'all') {
                dashboards = [...allDashboardsData.content, ...allDashboardsData.message, ...allDashboardsData.email];
            } else {
                dashboards = allDashboardsData[currentModalType] || [];
            }
            
            if (searchTerm) {
                dashboards = dashboards.filter(d => 
                    (d.name || '').toLowerCase().includes(searchTerm) ||
                    (d.description || '').toLowerCase().includes(searchTerm) ||
                    String(d.id).includes(searchTerm)
                );
            }
            
            renderDashboardCards(dashboards);
        }

        // Open dashboard in new tab
        function openDashboard(url) {
            if (url) {
                window.open(url, '_blank');
            }
        }

        // Track active update tasks per dashboard
        const activeUpdateTasks = new Map(); // dashboardId -> taskId
        
        // Show update confirmation on card (flip to show confirmation)
        function updateDashboard(dashboardId, dashboardType, dashboardName) {
            const container = document.querySelector(`.dashboard-card-container[data-dashboard-id="${dashboardId}"]`);
            if (!container) {
                showToast('Dashboard card not found', 'error');
                return;
            }
            
            // Reset views - show confirmation, hide progress
            const confirmView = document.getElementById(`confirm-view-${dashboardId}`);
            const progressView = document.getElementById(`progress-view-${dashboardId}`);
            
            if (confirmView) confirmView.classList.add('active');
            if (progressView) progressView.classList.remove('active');
            
            // Flip the card to show confirmation
            container.classList.add('flipped');
        }
        
        // Cancel the update confirmation (flip back without updating)
        function cancelUpdateConfirm(dashboardId) {
            const container = document.querySelector(`.dashboard-card-container[data-dashboard-id="${dashboardId}"]`);
            if (container) {
                container.classList.remove('flipped');
            }
        }
        
        // Show delete confirmation on card (flip to show delete confirmation)
        function deleteDashboard(dashboardId, dashboardType, dashboardName) {
            const container = document.querySelector(`.dashboard-card-container[data-dashboard-id="${dashboardId}"]`);
            if (!container) {
                showToast('Dashboard card not found', 'error');
                return;
            }
            
            // Hide all views, show delete confirmation
            const confirmView = document.getElementById(`confirm-view-${dashboardId}`);
            const deleteConfirmView = document.getElementById(`delete-confirm-view-${dashboardId}`);
            const progressView = document.getElementById(`progress-view-${dashboardId}`);
            
            if (confirmView) confirmView.classList.remove('active');
            if (deleteConfirmView) deleteConfirmView.classList.add('active');
            if (progressView) progressView.classList.remove('active');
            
            // Flip the card to show delete confirmation
            container.classList.add('flipped');
        }
        
        // Cancel delete confirmation (flip back)
        function cancelDeleteConfirm(dashboardId) {
            const container = document.querySelector(`.dashboard-card-container[data-dashboard-id="${dashboardId}"]`);
            if (container) {
                container.classList.remove('flipped');
            }
            
            // Reset views for next time
            setTimeout(() => {
                const confirmView = document.getElementById(`confirm-view-${dashboardId}`);
                const deleteConfirmView = document.getElementById(`delete-confirm-view-${dashboardId}`);
                
                if (confirmView) confirmView.classList.add('active');
                if (deleteConfirmView) deleteConfirmView.classList.remove('active');
            }, 300);
        }
        
        // Show edit name view on card (flip to show edit form)
        function editDashboard(dashboardId, dashboardType, dashboardName) {
            const container = document.querySelector(`.dashboard-card-container[data-dashboard-id="${dashboardId}"]`);
            if (!container) {
                showToast('Dashboard card not found', 'error');
                return;
            }
            
            // Hide all views, show edit view
            const confirmView = document.getElementById(`confirm-view-${dashboardId}`);
            const deleteConfirmView = document.getElementById(`delete-confirm-view-${dashboardId}`);
            const editView = document.getElementById(`edit-view-${dashboardId}`);
            const progressView = document.getElementById(`progress-view-${dashboardId}`);
            
            if (confirmView) confirmView.classList.remove('active');
            if (deleteConfirmView) deleteConfirmView.classList.remove('active');
            if (editView) editView.classList.add('active');
            if (progressView) progressView.classList.remove('active');
            
            // Set current name in input and focus it
            const editInput = document.getElementById(`edit-input-${dashboardId}`);
            if (editInput) {
                editInput.value = dashboardName;
                setTimeout(() => {
                    editInput.focus();
                    editInput.select();
                }, 350);
            }
            
            // Flip the card to show edit view
            container.classList.add('flipped');
        }
        
        // Cancel edit name (flip back)
        function cancelEditName(dashboardId) {
            const container = document.querySelector(`.dashboard-card-container[data-dashboard-id="${dashboardId}"]`);
            if (container) {
                container.classList.remove('flipped');
            }
            
            // Reset views for next time
            setTimeout(() => {
                const confirmView = document.getElementById(`confirm-view-${dashboardId}`);
                const editView = document.getElementById(`edit-view-${dashboardId}`);
                
                if (confirmView) confirmView.classList.add('active');
                if (editView) editView.classList.remove('active');
            }, 300);
        }
        
        // Save edited dashboard name
        async function saveEditName(dashboardId, dashboardType) {
            const editInput = document.getElementById(`edit-input-${dashboardId}`);
            const newName = editInput ? editInput.value.trim() : '';
            
            if (!newName) {
                showToast('Dashboard name cannot be empty', 'error');
                return;
            }
            
            const container = document.querySelector(`.dashboard-card-container[data-dashboard-id="${dashboardId}"]`);
            
            try {
                const response = await fetch(`/api/dashboard/rename/${dashboardId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        new_name: newName,
                        dashboard_type: dashboardType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`Dashboard renamed to "${newName}"`, 'success');
                    // Flip back
                    if (container) container.classList.remove('flipped');
                    // Refresh the dashboard list
                    await fetchAllDashboards();
                } else {
                    showToast(`Failed to rename dashboard: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Rename dashboard error:', error);
                showToast(`Failed to rename dashboard: ${error.message}`, 'error');
            }
        }
        
        // Proceed with delete after confirmation
        async function proceedWithDelete(dashboardId, dashboardType, dashboardName) {
            const container = document.querySelector(`.dashboard-card-container[data-dashboard-id="${dashboardId}"]`);
            
            try {
                const response = await fetch(`/api/dashboard/delete/${dashboardId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dashboard_type: dashboardType,
                        dashboard_name: dashboardName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`Dashboard "${dashboardName}" deleted successfully`, 'success');
                    // Flip back
                    if (container) container.classList.remove('flipped');
                    // Refresh the dashboard list
                    await fetchAllDashboards();
                } else {
                    showToast(`Failed to delete dashboard: ${data.error || 'Unknown error'}`, 'error');
                    // Flip back on error
                    if (container) container.classList.remove('flipped');
                }
            } catch (error) {
                console.error('Delete dashboard error:', error);
                showToast(`Failed to delete dashboard: ${error.message}`, 'error');
                // Flip back on error
                if (container) container.classList.remove('flipped');
            }
        }
        
        // Proceed with the actual update after confirmation
        async function proceedWithUpdate(dashboardId, dashboardType, dashboardName) {
            const container = document.querySelector(`.dashboard-card-container[data-dashboard-id="${dashboardId}"]`);
            if (!container) {
                showToast('Dashboard card not found', 'error');
                return;
            }
            
            // Switch from confirmation view to progress view
            const confirmView = document.getElementById(`confirm-view-${dashboardId}`);
            const progressView = document.getElementById(`progress-view-${dashboardId}`);
            
            if (confirmView) confirmView.classList.remove('active');
            if (progressView) progressView.classList.add('active');
            
            const progressFill = document.getElementById(`progress-fill-${dashboardId}`);
            const progressStatus = document.getElementById(`progress-status-${dashboardId}`);
            const cancelBtn = document.getElementById(`cancel-btn-${dashboardId}`);
            
            // Enable cancel button
            if (cancelBtn) {
                cancelBtn.disabled = false;
                cancelBtn.style.display = 'inline-flex';
            }
            
            // Helper to update progress
            const updateProgress = (percent, status, isError = false, isSuccess = false) => {
                if (progressFill) progressFill.style.width = `${percent}%`;
                if (progressStatus) {
                    progressStatus.textContent = status;
                    progressStatus.className = 'update-progress-status' + (isError ? ' error' : '') + (isSuccess ? ' success' : '');
                }
            };
            
            // Helper to hide cancel button
            const hideCancelBtn = () => {
                if (cancelBtn) {
                    cancelBtn.disabled = true;
                    cancelBtn.style.display = 'none';
                }
            };
            
            try {
                updateProgress(10, 'Connecting to server...');
                
                // Start the update process
                const response = await fetch('/api/dashboard/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dashboard_id: dashboardId,
                        dashboard_type: dashboardType,
                        dashboard_name: dashboardName
                    })
                });
                
                updateProgress(20, 'Processing...');
                
                // Check if response is OK
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Update failed');
                }
                
                // Poll for progress updates
                const data = await response.json();
                
                if (data.task_id) {
                    // Store task ID for cancel functionality
                    activeUpdateTasks.set(dashboardId, data.task_id);
                    
                    // Poll for progress
                    await pollUpdateProgress(data.task_id, dashboardId, dashboardType, updateProgress, hideCancelBtn);
                } else if (data.success) {
                    // Immediate success (no polling needed)
                    hideCancelBtn();
                    updateProgress(100, 'Update complete!', false, true);
                    
                    // Update the card with new URL
                    setTimeout(() => {
                        container.classList.remove('flipped');
                        // Refresh the dashboards list to get updated data
                        if (currentModalType === 'all' || currentModalType === dashboardType) {
                            fetchAllDashboards();
                        }
                        showToast(`Dashboard "${dashboardName}" updated successfully!`, 'success');
                    }, 1500);
                } else {
                    throw new Error(data.error || 'Update failed');
                }
                
            } catch (error) {
                console.error('Dashboard update error:', error);
                hideCancelBtn();
                updateProgress(0, `Error: ${error.message}`, true);
                
                // Flip back after showing error
                setTimeout(() => {
                    container.classList.remove('flipped');
                }, 3000);
                
                showToast(`Failed to update dashboard: ${error.message}`, 'error');
            } finally {
                // Clean up task tracking
                activeUpdateTasks.delete(dashboardId);
            }
        }
        
        // Cancel a running dashboard update
        async function cancelDashboardUpdate(dashboardId) {
            const taskId = activeUpdateTasks.get(dashboardId);
            if (!taskId) {
                showToast('No active update to cancel', 'warning');
                return;
            }
            
            const cancelBtn = document.getElementById(`cancel-btn-${dashboardId}`);
            if (cancelBtn) {
                cancelBtn.disabled = true;
                cancelBtn.textContent = 'Cancelling...';
            }
            
            try {
                const response = await fetch(`/api/dashboard/update/cancel/${taskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Cancelling update...', 'info');
                } else {
                    showToast(data.error || 'Failed to cancel', 'error');
                }
            } catch (error) {
                console.error('Error cancelling update:', error);
                showToast('Failed to cancel update', 'error');
            }
        }
        
        // Poll for update progress
        async function pollUpdateProgress(taskId, dashboardId, dashboardType, updateProgress, hideCancelBtn) {
            const container = document.querySelector(`.dashboard-card-container[data-dashboard-id="${dashboardId}"]`);
            const maxAttempts = 300; // 5 minutes max (1 second intervals) - cloning can take a while
            let attempts = 0;
            
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(`/api/dashboard/update/status/${taskId}`);
                    const data = await response.json();
                    
                    if (data.progress !== undefined) {
                        updateProgress(data.progress, data.status || 'Processing...');
                    }
                    
                    if (data.completed) {
                        hideCancelBtn();
                        
                        if (data.cancelled) {
                            // Update was cancelled
                            updateProgress(0, 'Update cancelled - original dashboard preserved', true);
                            setTimeout(() => {
                                if (container) container.classList.remove('flipped');
                            }, 2000);
                            showToast('Update cancelled. Original dashboard preserved.', 'info');
                        } else if (data.success) {
                            updateProgress(100, 'Update complete!', false, true);
                            
                            // Flip back and refresh
                            setTimeout(() => {
                                if (container) container.classList.remove('flipped');
                                // Refresh the dashboards list
                                fetchAllDashboards();
                                showToast(`Dashboard updated successfully!`, 'success');
                            }, 1500);
                        } else {
                            updateProgress(data.progress || 0, `Error: ${data.error || 'Update failed'}`, true);
                            setTimeout(() => {
                                if (container) container.classList.remove('flipped');
                            }, 3000);
                            showToast(`Update failed: ${data.error || 'Unknown error'}`, 'error');
                        }
                        return;
                    }
                    
                    // Wait before next poll
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    attempts++;
                    
                } catch (error) {
                    console.error('Error polling update status:', error);
                    attempts++;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            // Timeout
            hideCancelBtn();
            updateProgress(0, 'Update timed out', true);
            setTimeout(() => {
                if (container) container.classList.remove('flipped');
            }, 3000);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =================================================================
        // DASHBOARD MERGE FUNCTIONS
        // =================================================================
        
        // Toggle dashboard selection for merge
        function toggleDashboardSelection(id, name, type, url) {
            // Check if we can add this dashboard (same type only)
            if (selectedDashboards.size > 0) {
                const firstSelected = selectedDashboards.values().next().value;
                if (firstSelected.type !== type) {
                    showToast(`Can only merge dashboards of the same type. Currently selecting: ${firstSelected.type}`, 'error');
                    return;
                }
            }
            
            if (selectedDashboards.has(id)) {
                selectedDashboards.delete(id);
            } else {
                selectedDashboards.set(id, { id, name, type, url });
            }
            
            updateMergeToolbar();
            // Re-render to update selection state
            filterDashboardCards();
        }
        
        // Update merge toolbar visibility and content
        function updateMergeToolbar() {
            const toolbar = document.getElementById('merge-toolbar');
            const countEl = document.getElementById('merge-count');
            const createBtn = document.getElementById('create-merge-btn');
            
            if (selectedDashboards.size > 0) {
                toolbar.classList.add('active');
                countEl.textContent = selectedDashboards.size;
                createBtn.disabled = selectedDashboards.size < 2;
            } else {
                toolbar.classList.remove('active');
            }
        }
        
        // Clear merge selection
        function clearMergeSelection() {
            selectedDashboards.clear();
            document.getElementById('merge-name-input').value = '';
            updateMergeToolbar();
            filterDashboardCards();
        }
        
        // Create merged dashboard
        async function createMergedDashboard() {
            const nameInput = document.getElementById('merge-name-input');
            const name = nameInput.value.trim();
            
            if (!name) {
                showToast('Please enter a name for the merged dashboard', 'error');
                nameInput.focus();
                return;
            }
            
            if (selectedDashboards.size < 2) {
                showToast('Select at least 2 dashboards to merge', 'error');
                return;
            }
            
            const createBtn = document.getElementById('create-merge-btn');
            createBtn.disabled = true;
            createBtn.innerHTML = '<svg class="spin" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"></path></svg> Creating...';
            
            try {
                const sourceDashboards = Array.from(selectedDashboards.values()).map(d => ({
                    id: d.id,
                    name: d.name
                }));
                
                const type = sourceDashboards[0] ? selectedDashboards.values().next().value.type : 'content';
                
                const response = await fetch('/api/merged-dashboards', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        type: type,
                        source_dashboards: sourceDashboards
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Merged dashboard created successfully!', 'success');
                    clearMergeSelection();
                    closeDashboardsModal();
                    loadMergedDashboards();
                } else {
                    showToast(data.error || 'Failed to create merged dashboard', 'error');
                }
            } catch (error) {
                console.error('Failed to create merged dashboard:', error);
                showToast('Failed to create merged dashboard', 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg> Create Merged Dashboard';
                updateMergeToolbar();
            }
        }
        
        // Load merged dashboards list
        async function loadMergedDashboards() {
            try {
                const response = await fetch('/api/merged-dashboards');
                const data = await response.json();
                
                if (data.success) {
                    mergedDashboardsList = data.dashboards || [];
                    renderMergedDashboards();
                }
            } catch (error) {
                console.error('Failed to load merged dashboards:', error);
            }
        }
        
        // Render merged dashboards list
        function renderMergedDashboards() {
            const listEl = document.getElementById('merged-list');
            const countEl = document.getElementById('merged-count');
            
            countEl.textContent = `${mergedDashboardsList.length} merged`;
            
            if (mergedDashboardsList.length === 0) {
                listEl.innerHTML = `
                    <div class="merged-empty">
                        <p>No merged dashboards yet</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Click on dashboard cards and use the + button to select dashboards for merging</p>
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = mergedDashboardsList.map(d => `
                <div class="merged-item">
                    <span class="merged-item-type ${d.type}">${d.type}</span>
                    <div class="merged-item-info">
                        <div class="merged-item-name">${escapeHtml(d.name)}</div>
                        <div class="merged-item-meta">
                            <span>${d.source_dashboards?.length || 0} sources</span>
                            <span>Created: ${formatDate(d.created_at)}</span>
                            ${d.created_by?.name ? `<span>By: ${escapeHtml(d.created_by.name)}</span>` : ''}
                        </div>
                    </div>
                    <div class="merged-item-actions">
                        <button class="merged-item-btn view" id="view-merged-${d.id}" onclick="viewMergedDashboard('${d.id}')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            View
                        </button>
                        <button class="merged-item-btn delete" onclick="deleteMergedDashboard('${d.id}', '${escapeHtml(d.name)}')">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Format date for display
        function formatDate(isoString) {
            if (!isoString) return 'Unknown';
            const date = new Date(isoString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        // Delete merged dashboard
        async function deleteMergedDashboard(id, name) {
            if (!confirm(`Are you sure you want to delete "${name}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/merged-dashboards/${id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Merged dashboard deleted', 'success');
                    loadMergedDashboards();
                } else {
                    showToast(data.error || 'Failed to delete', 'error');
                }
            } catch (error) {
                console.error('Failed to delete merged dashboard:', error);
                showToast('Failed to delete merged dashboard', 'error');
            }
        }
        
        // Current merged dashboard data (for tab switching)
        let currentMergedDashboard = null;
        let currentMergedTabId = null;
        let chartInstances = {}; // Store Chart.js instances for cleanup
        
        // Chart.js color palette
        const chartColors = [
            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
            '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#14b8a6',
            '#a855f7', '#22c55e', '#eab308', '#dc2626', '#6366f1'
        ];
        
        // View merged dashboard
        async function viewMergedDashboard(id) {
            const modal = document.getElementById('merged-viewer-modal');
            const titleEl = document.getElementById('merged-viewer-title');
            const metaEl = document.getElementById('merged-viewer-meta');
            const gridEl = document.getElementById('merged-cards-grid');
            const tabsEl = document.getElementById('merged-tabs');
            const filtersEl = document.getElementById('merged-filters');
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Cleanup previous chart instances
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};
            
            titleEl.textContent = 'Loading...';
            metaEl.textContent = '';
            gridEl.innerHTML = '<div class="merged-card-loading">Loading dashboard data...</div>';
            tabsEl.style.display = 'none';
            filtersEl.style.display = 'none';
            
            try {
                const response = await fetch(`/api/merged-dashboard-data/${id}`);
                const data = await response.json();
                
                if (data.success && data.merged_dashboard) {
                    const dashboard = data.merged_dashboard;
                    currentMergedDashboard = dashboard;
                    
                    titleEl.textContent = dashboard.name;
                    metaEl.textContent = `${dashboard.type.toUpperCase()} | ${dashboard.source_count} sources | ${dashboard.cards?.length || 0} cards`;
                    
                    // Filters disabled for now
                    // if (dashboard.parameters && dashboard.parameters.length > 0) {
                    //     renderMergedFilters(dashboard.parameters);
                    // }
                    
                    // Render tabs if present
                    if (dashboard.tabs && dashboard.tabs.length > 0) {
                        renderMergedTabs(dashboard.tabs);
                        // Set first tab as active
                        currentMergedTabId = dashboard.tabs[0].id;
                    } else {
                        currentMergedTabId = null;
                        tabsEl.style.display = 'none';
                    }
                    
                    // Store original cards for filtering
                    originalMergedCards = JSON.parse(JSON.stringify(dashboard.cards || []));
                    
                    renderMergedCards(dashboard.cards || [], currentMergedTabId);
                } else {
                    gridEl.innerHTML = `<div class="merged-card-loading">Error: ${data.error || 'Failed to load data'}</div>`;
                }
            } catch (error) {
                console.error('Failed to load merged dashboard:', error);
                gridEl.innerHTML = '<div class="merged-card-loading">Failed to load dashboard data</div>';
            }
        }
        
        // Store current filter values globally
        let currentMergedFilters = {};
        // Store original unfiltered cards for filtering
        let originalMergedCards = null;
        
        // Render filters based on dashboard parameters
        function renderMergedFilters(parameters) {
            const filtersEl = document.getElementById('merged-filters');
            if (!parameters || parameters.length === 0) {
                filtersEl.style.display = 'none';
                return;
            }
            
            // First, collect all unique values from ALL cards for each filter
            const filterOptions = {};
            parameters.forEach(param => {
                filterOptions[param.id] = new Set();
            });
            
            // Scan all cards to find filter values
            if (currentMergedDashboard && currentMergedDashboard.cards) {
                currentMergedDashboard.cards.forEach(card => {
                    if (!card.data || !card.data.rows || !card.data.cols) return;
                    
                    card.data.cols.forEach((col, colIdx) => {
                        const colName = (col.name || col.display_name || '').toLowerCase().replace(/[_-]/g, '');
                        
                        // Try to match column to a parameter
                        parameters.forEach(param => {
                            const paramName = (param.name || '').toLowerCase().replace(/[_-]/g, '');
                            const paramSlug = (param.slug || '').toLowerCase().replace(/[_-]/g, '');
                            
                            // Match by name similarity - be more flexible
                            const matches = 
                                colName === paramName ||
                                colName === paramSlug ||
                                colName.includes(paramName) || 
                                paramName.includes(colName) ||
                                colName.includes(paramSlug) || 
                                paramSlug.includes(colName) ||
                                // Common field name variations
                                (colName.includes('user') && paramName.includes('user')) ||
                                (colName.includes('email') && paramName.includes('email')) ||
                                (colName.includes('status') && paramName.includes('status')) ||
                                (colName.includes('cloud') && paramName.includes('cloud')) ||
                                (colName.includes('process') && paramName.includes('process')) ||
                                (colName.includes('from') && paramName.includes('from')) ||
                                (colName.includes('to') && paramName.includes('to')) ||
                                (colName.includes('date') && paramName.includes('date')) ||
                                (colName.includes('type') && paramName.includes('type'));
                            
                            if (matches) {
                                card.data.rows.forEach(row => {
                                    const val = row[colIdx];
                                    if (val !== null && val !== undefined && val !== '') {
                                        filterOptions[param.id].add(String(val));
                                    }
                                });
                            }
                        });
                    });
                });
            }
            
            console.log('Filter options collected:', Object.fromEntries(
                Object.entries(filterOptions).map(([k, v]) => [k, Array.from(v).slice(0, 5)])
            ));
            
            filtersEl.style.display = 'flex';
            filtersEl.innerHTML = parameters.map(param => {
                const paramType = param.type || '';
                const paramName = param.name || '';
                const paramId = param.id;
                
                const paramSlug = param.slug || paramName;
                
                // For boolean filters, create a dropdown with Yes/No
                if (paramType.includes('boolean')) {
                    return `
                        <div class="merged-filter-group">
                            <span class="merged-filter-label">${escapeHtml(paramName)}</span>
                            <select class="merged-filter-select" data-param-id="${paramId}" data-param-name="${paramName}" data-param-slug="${paramSlug}" data-param-type="boolean" onchange="applyMergedFilter()">
                                <option value="">All</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                    `;
                }
                
                // For string filters, create dropdown with collected values
                const options = Array.from(filterOptions[paramId] || []).sort().slice(0, 100);
                const optionsHtml = options.map(val => 
                    `<option value="${escapeHtml(val)}">${escapeHtml(val.length > 40 ? val.substring(0, 37) + '...' : val)}</option>`
                ).join('');
                
                return `
                    <div class="merged-filter-group">
                        <span class="merged-filter-label">${escapeHtml(paramName)}</span>
                        <select class="merged-filter-select" data-param-id="${paramId}" data-param-name="${paramName}" data-param-slug="${paramSlug}" data-param-type="string" onchange="applyMergedFilter()">
                            <option value="">All${options.length > 0 ? ` (${options.length})` : ''}</option>
                            ${optionsHtml}
                        </select>
                    </div>
                `;
            }).join('');
        }
        
        // Apply filters - server-side filtering by re-fetching data with filter params
        async function applyMergedFilter() {
            if (!currentMergedDashboard) return;
            
            // Collect current filter values
            const filters = {};
            document.querySelectorAll('.merged-filter-select').forEach(el => {
                const paramName = el.dataset.paramName;
                const paramSlug = el.dataset.paramSlug || paramName;
                const value = el.value;
                if (paramName && value) {
                    // Use the parameter name/slug as the key for the query string
                    filters[paramSlug] = value;
                }
            });
            
            currentMergedFilters = filters;
            console.log('Applying filters (server-side):', filters);
            
            // If no filters, show original data
            if (Object.keys(filters).length === 0) {
                console.log('No filters, showing original cards');
                if (originalMergedCards) {
                    renderMergedCards(originalMergedCards, currentMergedTabId);
                }
                return;
            }
            
            // Build query string from filters
            const queryParams = new URLSearchParams(filters).toString();
            const dashboardId = currentMergedDashboard._id || currentMergedDashboard.id;
            
            // Show loading state
            const gridEl = document.getElementById('merged-cards-grid');
            gridEl.innerHTML = '<div class="merged-card-loading" style="grid-column: span 24;">Applying filters...</div>';
            
            try {
                // Re-fetch data with filter parameters
                const response = await fetch(`/api/merged-dashboard-data/${dashboardId}?${queryParams}`);
                const data = await response.json();
                
                if (data.success && data.merged_dashboard) {
                    const dashboard = data.merged_dashboard;
                    
                    // Update the cards with filtered data
                    renderMergedCards(dashboard.cards || [], currentMergedTabId);
                    console.log('Filtered data loaded:', dashboard.cards?.length, 'cards');
                } else {
                    console.error('Filter request failed:', data.error);
                    gridEl.innerHTML = `<div class="merged-card-loading" style="grid-column: span 24;">Error: ${data.error || 'Failed to apply filters'}</div>`;
                }
            } catch (error) {
                console.error('Filter request error:', error);
                gridEl.innerHTML = '<div class="merged-card-loading" style="grid-column: span 24;">Failed to apply filters</div>';
            }
        }
        
        // Render tabs
        function renderMergedTabs(tabs) {
            const tabsEl = document.getElementById('merged-tabs');
            if (!tabs || tabs.length === 0) {
                tabsEl.style.display = 'none';
                return;
            }
            
            // Filter out tabs with name "." (hidden/user tabs)
            const visibleTabs = tabs.filter(t => t.name && t.name.trim() !== '.');
            
            // Show tabs even if there's only one (user might want to see tab name)
            if (visibleTabs.length === 0) {
                tabsEl.style.display = 'none';
                return;
            }
            
            // If only 1 tab and it's generic like "Tab 1", hide the tab bar
            if (visibleTabs.length === 1 && visibleTabs[0].name === 'Tab 1') {
                tabsEl.style.display = 'none';
                return;
            }
            
            tabsEl.style.display = 'flex';
            tabsEl.innerHTML = visibleTabs.map((tab, idx) => `
                <button class="merged-tab ${idx === 0 ? 'active' : ''}" onclick="switchMergedTab(${tab.id})" data-tab-id="${tab.id}">
                    ${escapeHtml(tab.name || `Tab ${idx + 1}`)}
                </button>
            `).join('');
        }
        
        // Switch tab
        function switchMergedTab(tabId) {
            currentMergedTabId = tabId;
            
            // Update tab buttons
            document.querySelectorAll('.merged-tab').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tabId == tabId) {
                    btn.classList.add('active');
                }
            });
            
            // Re-render cards for this tab
            if (currentMergedDashboard) {
                renderMergedCards(currentMergedDashboard.cards || [], tabId);
            }
        }
        
        // Render merged dashboard cards
        function renderMergedCards(cards, tabId) {
            const gridEl = document.getElementById('merged-cards-grid');
            
            // Cleanup previous chart instances
            Object.values(chartInstances).forEach(chart => {
                try { chart.destroy(); } catch(e) {}
            });
            chartInstances = {};
            
            if (!cards || cards.length === 0) {
                gridEl.innerHTML = '<div class="merged-card-loading" style="grid-column: span 24;">No cards found in this dashboard</div>';
                return;
            }
            
            // Filter cards by tab if tabId is specified
            let filteredCards = cards;
            if (tabId !== null && tabId !== undefined) {
                filteredCards = cards.filter(c => c.dashboard_tab_id === tabId);
            }
            
            if (filteredCards.length === 0) {
                gridEl.innerHTML = '<div class="merged-card-loading" style="grid-column: span 24;">No cards in this tab</div>';
                return;
            }
            
            // Sort cards by row then col for proper layout
            filteredCards.sort((a, b) => {
                const rowDiff = (a.row || 0) - (b.row || 0);
                if (rowDiff !== 0) return rowDiff;
                return (a.col || 0) - (b.col || 0);
            });
            
            // Store cards for click behavior reference
            window.mergedCardsData = filteredCards;
            
            gridEl.innerHTML = filteredCards.map((card, idx) => {
                const displayType = card.display || 'table';
                const cardId = `chart-${idx}-${Date.now()}`;
                const hasClickBehavior = card.click_behavior && card.click_behavior.type;
                
                // Calculate grid position based on Metabase's 24-column grid
                const colSpan = Math.min(card.size_x || 6, 24);
                const gridStyle = `grid-column: span ${colSpan};`;
                
                // Click behavior disabled for now
                return `
                    <div class="merged-card" 
                         style="${gridStyle}" data-card-index="${idx}">
                        <div class="merged-card-header">
                            <span class="merged-card-title" title="${escapeHtml(card.name || 'Unnamed Card')}">${escapeHtml(card.name || 'Unnamed Card')}</span>
                            <span class="merged-card-type">${displayType}</span>
                        </div>
                        <div class="merged-card-body" id="card-body-${idx}">
                            ${renderCardContent(card, displayType, cardId, idx)}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Initialize Chart.js charts after DOM is ready
            const cardsToRender = [...filteredCards];
            setTimeout(() => {
                cardsToRender.forEach((card, idx) => {
                    const displayType = card.display || 'table';
                    if (displayType === 'pie') {
                        initPieChart(card, idx);
                    } else if (displayType === 'bar' || displayType === 'row') {
                        initBarChart(card, idx, displayType);
                    } else if (displayType === 'line' || displayType === 'area') {
                        initLineChart(card, idx);
                    }
                });
            }, 100);
        }
        
        // Drill-through navigation stack for multi-level drill-through
        let drillThroughStack = [];
        
        // Handle card click behavior - this is the main entry point for drill-through
        function handleCardClick(cardIdx, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            console.log('handleCardClick called with index:', cardIdx);
            
            const card = window.mergedCardsData ? window.mergedCardsData[cardIdx] : null;
            if (!card) {
                console.error('Card not found at index', cardIdx, 'mergedCardsData:', window.mergedCardsData);
                alert('Card data not found. Please try again.');
                return;
            }
            
            console.log('Card clicked:', cardIdx, card.name, card.display, 'click_behavior:', card.click_behavior);
            
            // Check if card has click behavior configured
            if (card.click_behavior && card.click_behavior.targetId) {
                // This card has a drill-through target - fetch data from target dashboard/question
                const clickBehavior = card.click_behavior;
                const targetType = clickBehavior.linkType || 'dashboard';
                const targetId = clickBehavior.targetId;
                const paramMapping = clickBehavior.parameterMapping || {};
                
                // Build filter params from the card's data
                // For charts, we need to determine what was clicked (this is simplified - real implementation would track click position)
                let filterParams = {};
                
                // If we have parameter mapping, use it to build filters
                if (Object.keys(paramMapping).length > 0) {
                    // Get the first row of data as default filter values
                    if (card.data && card.data.rows && card.data.rows[0]) {
                        const cols = card.data.cols || [];
                        const firstRow = card.data.rows[0];
                        
                        // Map column values to parameters
                        Object.entries(paramMapping).forEach(([paramId, mapping]) => {
                            const sourceId = mapping.source?.id;
                            const targetParamId = mapping.target?.id;
                            
                            // Find the column index for this source
                            if (sourceId) {
                                const colIdx = cols.findIndex(c => c.name === sourceId || c.id === sourceId);
                                if (colIdx >= 0 && firstRow[colIdx] !== undefined) {
                                    filterParams[targetParamId || sourceId] = firstRow[colIdx];
                                }
                            }
                        });
                    }
                }
                
                // Start drill-through
                drillThroughStack = []; // Reset stack for new drill-through
                performDrillThrough(targetType, targetId, filterParams, card.name);
            } else {
                // No click behavior - show the card's own data in a modal
                showCardDataModal(card);
            }
        }
        
        // Make handleCardClick globally accessible
        window.handleCardClick = handleCardClick;
        
        // Perform drill-through by fetching data from target dashboard/question
        async function performDrillThrough(targetType, targetId, filterParams, sourceName) {
            console.log('Performing drill-through:', { targetType, targetId, filterParams, sourceName });
            
            // Show loading modal
            showDrillDownModal({
                name: `Loading drill-through data...`,
                loading: true
            });
            
            try {
                const response = await fetch('/api/drill-through', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        targetType: targetType,
                        targetId: targetId,
                        filterParams: filterParams
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.drill_through) {
                    // Push to navigation stack
                    drillThroughStack.push({
                        type: targetType,
                        id: targetId,
                        name: data.drill_through.name,
                        filters: filterParams
                    });
                    
                    // Show the drill-through data
                    showDrillThroughModal(data.drill_through);
                } else {
                    showDrillDownModal({
                        name: 'Drill-through Error',
                        error: data.error || 'Failed to fetch drill-through data'
                    });
                }
            } catch (error) {
                console.error('Drill-through error:', error);
                showDrillDownModal({
                    name: 'Drill-through Error',
                    error: error.message || 'Network error'
                });
            }
        }
        
        // Show drill-through data in modal
        function showDrillThroughModal(drillData) {
            let modal = document.getElementById('drilldown-modal');
            if (!modal) {
                modal = createDrillDownModal();
            }
            
            const titleEl = document.getElementById('drilldown-title');
            const bodyEl = document.getElementById('drilldown-body');
            
            // Build breadcrumb navigation
            let breadcrumb = '';
            if (drillThroughStack.length > 0) {
                breadcrumb = `<div class="drill-breadcrumb">
                    <span class="breadcrumb-item" onclick="closeDrillDownModal()">Merged Dashboard</span>
                    ${drillThroughStack.map((item, idx) => `
                        <span class="breadcrumb-separator">â†’</span>
                        <span class="breadcrumb-item ${idx === drillThroughStack.length - 1 ? 'active' : ''}" 
                              ${idx < drillThroughStack.length - 1 ? `onclick="navigateToDrillLevel(${idx})"` : ''}>
                            ${escapeHtml(item.name)}
                        </span>
                    `).join('')}
                </div>`;
            }
            
            titleEl.innerHTML = `${escapeHtml(drillData.name)} <span class="drill-type-badge">${drillData.type}</span>`;
            
            let content = breadcrumb;
            
            // Show applied filters
            if (drillData.applied_filters && Object.keys(drillData.applied_filters).length > 0) {
                content += `<div class="drill-filters-applied">
                    <strong>Filters Applied:</strong>
                    ${Object.entries(drillData.applied_filters).map(([k, v]) => `
                        <span class="filter-tag">${escapeHtml(k)}: ${escapeHtml(String(v))}</span>
                    `).join('')}
                </div>`;
            }
            
            // Render cards from the drill-through dashboard
            if (drillData.cards && drillData.cards.length > 0) {
                content += `<div class="drill-cards-grid">`;
                
                drillData.cards.forEach((card, idx) => {
                    const hasClickBehavior = card.click_behavior && card.click_behavior.targetId;
                    content += `
                        <div class="drill-card ${hasClickBehavior ? 'has-click-behavior' : ''}" 
                             data-drill-card-idx="${idx}"
                             ${hasClickBehavior ? `onclick="handleDrillCardClick(${idx})" style="cursor: pointer;"` : ''}>
                            <div class="drill-card-header">
                                <span class="drill-card-title">${escapeHtml(card.name)}</span>
                                <span class="drill-card-type">${card.display}${hasClickBehavior ? ' <span style="color: var(--accent-blue);">â†—</span>' : ''}</span>
                            </div>
                            <div class="drill-card-body">
                                ${renderDrillCardContent(card, idx)}
                            </div>
                        </div>
                    `;
                });
                
                content += `</div>`;
                
                // Store drill cards for click handling
                window.drillCardsData = drillData.cards;
            } else if (drillData.data) {
                // Single question result
                content += renderDrillDataTable(drillData.data, drillData.columns);
            } else {
                content += '<p class="no-data">No data available</p>';
            }
            
            bodyEl.innerHTML = content;
            modal.classList.add('active');
            
            // Initialize any charts in drill-through cards
            setTimeout(() => {
                if (drillData.cards) {
                    drillData.cards.forEach((card, idx) => {
                        initDrillChart(card, idx);
                    });
                }
            }, 100);
        }
        
        // Handle click on a card within drill-through modal (for multi-level drill)
        function handleDrillCardClick(cardIdx) {
            const card = window.drillCardsData ? window.drillCardsData[cardIdx] : null;
            if (!card) return;
            
            if (card.click_behavior && card.click_behavior.targetId) {
                const cb = card.click_behavior;
                const targetType = cb.linkType || 'dashboard';
                const targetId = cb.targetId;
                
                // Build filter params from clicked card's data
                let filterParams = {};
                if (card.data && card.data.rows && card.data.rows[0]) {
                    const cols = card.data.cols || [];
                    const firstRow = card.data.rows[0];
                    
                    // Use first column as filter (simplified)
                    if (cols[0] && firstRow[0] !== undefined) {
                        filterParams[cols[0].name || 'filter'] = firstRow[0];
                    }
                }
                
                // Perform next level drill-through
                performDrillThrough(targetType, targetId, filterParams, card.name);
            }
        }
        window.handleDrillCardClick = handleDrillCardClick;
        
        // Navigate back to a specific drill level
        function navigateToDrillLevel(levelIdx) {
            if (levelIdx < 0 || levelIdx >= drillThroughStack.length - 1) return;
            
            // Pop stack to the desired level
            const targetLevel = drillThroughStack[levelIdx];
            drillThroughStack = drillThroughStack.slice(0, levelIdx);
            
            // Re-fetch that level's data
            performDrillThrough(targetLevel.type, targetLevel.id, targetLevel.filters, targetLevel.name);
        }
        window.navigateToDrillLevel = navigateToDrillLevel;
        
        // Render content for a drill-through card
        function renderDrillCardContent(card, idx) {
            const displayType = card.display || 'table';
            const data = card.data;
            
            if (!data || !data.rows || data.rows.length === 0) {
                return '<div class="no-data">No data</div>';
            }
            
            if (displayType === 'scalar' || displayType === 'number') {
                const value = data.rows[0][data.rows[0].length - 1];
                return `<div class="drill-scalar-value">${formatNumber(value)}</div>`;
            } else if (displayType === 'table') {
                return renderDrillDataTable(data, card.columns, 10); // Show first 10 rows
            } else if (displayType === 'pie' || displayType === 'bar' || displayType === 'row' || displayType === 'line') {
                return `<div class="drill-chart-container" id="drill-chart-${idx}"></div>`;
            } else {
                return `<div class="no-data">${data.rows.length} rows</div>`;
            }
        }
        
        // Render data as table for drill-through
        function renderDrillDataTable(data, columns, maxRows = 50) {
            if (!data || !data.rows || data.rows.length === 0) {
                return '<div class="no-data">No data</div>';
            }
            
            const cols = data.cols || columns || [];
            const rows = data.rows.slice(0, maxRows);
            const totalRows = data.rows.length;
            
            return `
                <div class="drill-table-container">
                    <table class="drill-table">
                        <thead>
                            <tr>
                                ${cols.map(col => `<th>${escapeHtml(col.display_name || col.name || 'Column')}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.map(row => `
                                <tr>
                                    ${row.map((cell, i) => `<td>${formatCellValue(cell)}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${totalRows > maxRows ? `<div class="table-footer">Showing ${maxRows} of ${totalRows} rows</div>` : ''}
                </div>
            `;
        }
        
        // Initialize chart for drill-through card
        function initDrillChart(card, idx) {
            const container = document.getElementById(`drill-chart-${idx}`);
            if (!container || !card.data || !card.data.rows) return;
            
            const displayType = card.display || 'table';
            const data = card.data;
            
            // Simple chart rendering using Chart.js
            const canvas = document.createElement('canvas');
            canvas.id = `drill-canvas-${idx}`;
            canvas.style.maxHeight = '200px';
            container.appendChild(canvas);
            
            const labels = data.rows.map(r => r[0]);
            const values = data.rows.map(r => r[r.length - 1]);
            
            const chartType = displayType === 'pie' ? 'pie' : (displayType === 'line' ? 'line' : 'bar');
            
            new Chart(canvas, {
                type: chartType,
                data: {
                    labels: labels.slice(0, 10),
                    datasets: [{
                        data: values.slice(0, 10),
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                            '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: displayType === 'pie' } }
                }
            });
        }
        
        // Show card's own data in modal (when no click behavior)
        function showCardDataModal(card) {
            let modal = document.getElementById('drilldown-modal');
            if (!modal) {
                modal = createDrillDownModal();
            }
            
            const titleEl = document.getElementById('drilldown-title');
            const bodyEl = document.getElementById('drilldown-body');
            
            titleEl.textContent = card.name || 'Card Details';
            
            let content = '';
            
            // Card info
            content += `<div class="drilldown-info">
                <p><strong>Type:</strong> ${card.display || 'Unknown'}</p>
                <p><strong>Sources:</strong> ${card.source_count || currentMergedDashboard?.source_count || 'N/A'} dashboards merged</p>
            </div>`;
            
            // Show data
            if (card.data && card.data.rows && card.data.rows.length > 0) {
                content += renderDrillDataTable(card.data, card.columns, 100);
            } else {
                content += '<p class="no-data">No data available</p>';
            }
            
            bodyEl.innerHTML = content;
            modal.classList.add('active');
        }
        
        // Create drill-down modal
        function createDrillDownModal() {
            const modal = document.createElement('div');
            modal.id = 'drilldown-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 1100px; max-height: 85vh; overflow: auto;">
                    <div class="modal-header">
                        <h2 id="drilldown-title">Details</h2>
                        <button class="close-btn" onclick="closeDrillDownModal()">&times;</button>
                    </div>
                    <div class="modal-body" id="drilldown-body"></div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }
        
        // Show drill-down modal (generic)
        function showDrillDownModal(options) {
            let modal = document.getElementById('drilldown-modal');
            if (!modal) {
                modal = createDrillDownModal();
            }
            
            const titleEl = document.getElementById('drilldown-title');
            const bodyEl = document.getElementById('drilldown-body');
            
            titleEl.textContent = options.name || 'Details';
            
            if (options.loading) {
                bodyEl.innerHTML = `<div class="drill-loading">
                    <div class="spinner"></div>
                    <p>Fetching drill-through data...</p>
                </div>`;
            } else if (options.error) {
                bodyEl.innerHTML = `<div class="drill-error">
                    <p style="color: var(--accent-red);">Error: ${escapeHtml(options.error)}</p>
                </div>`;
            }
            
            modal.classList.add('active');
        }
        
        // Close drill-down modal
        function closeDrillDownModal() {
            const modal = document.getElementById('drilldown-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            // Reset drill-through stack
            drillThroughStack = [];
            window.drillCardsData = null;
        }
        
        // Make closeDrillDownModal globally accessible
        window.closeDrillDownModal = closeDrillDownModal;
        
        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('drilldown-modal');
            if (modal && modal.classList.contains('active')) {
                if (e.target === modal) {
                    closeDrillDownModal();
                }
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDrillDownModal();
            }
        });
        
        // Format cell value for display
        function formatCellValue(value) {
            if (value === null || value === undefined) return '<span class="null-value">-</span>';
            if (typeof value === 'number') {
                return value.toLocaleString();
            }
            if (typeof value === 'boolean') {
                return value ? 'Yes' : 'No';
            }
            const str = String(value);
            if (str.length > 50) {
                return `<span title="${escapeHtml(str)}">${escapeHtml(str.substring(0, 47))}...</span>`;
            }
            return escapeHtml(str);
        }
        
        // Render card content based on type
        function renderCardContent(card, displayType, cardId, cardIdx) {
            if (displayType === 'scalar' || displayType === 'number' || displayType === 'progress') {
                return renderScalarCard(card, cardIdx);
            } else if (displayType === 'table') {
                return renderMergedTable(card.data, cardIdx);
            } else if (displayType === 'pie' || displayType === 'bar' || displayType === 'row' || displayType === 'line' || displayType === 'area') {
                // Chart container - actual chart will be rendered by init functions
                return `<div class="chart-container"></div>`;
            } else {
                // Fallback for other chart types
                const rowCount = card.data?.rows?.length || 0;
                return `
                    <div class="no-data">
                        <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">${displayType.toUpperCase()}</p>
                        <p>${rowCount} data points</p>
                    </div>
                `;
            }
        }
        
        // Render scalar/number card
        function renderScalarCard(card, cardIdx) {
            const data = card.data;
            if (!data || !data.rows || data.rows.length === 0) {
                return '<div class="no-data">No data</div>';
            }
            
            // Get the value - typically last column of first row
            const row = data.rows[0];
            let value = row[row.length - 1];
            let label = row[0];
            
            // If value is null, try other columns
            if (value === null && row.length > 1) {
                for (let i = row.length - 1; i >= 0; i--) {
                    if (row[i] !== null && typeof row[i] === 'number') {
                        value = row[i];
                        break;
                    }
                }
            }
            
            const formattedValue = typeof value === 'number' ? value.toLocaleString() : (value ?? 'N/A');
            const sizeClass = String(formattedValue).length > 6 ? 'small' : '';
            const hasClick = card.click_behavior && card.click_behavior.type;
            
            return `<div class="merged-card-value ${sizeClass} ${hasClick ? 'clickable' : ''}">${formattedValue}</div>`;
        }
        
        // Initialize Pie Chart with Chart.js
        function initPieChart(card, idx) {
            console.log('initPieChart called for card', idx, card.name, card.data);
            const canvasId = `pie-chart-${idx}-${Date.now()}`;
            const container = document.querySelector(`[data-card-index="${idx}"] .chart-container`);
            if (!container) {
                console.log('No container found for card', idx);
                return;
            }
            
            const data = card.data;
            if (!data || !data.rows || data.rows.length === 0) {
                console.log('No data for pie chart', idx, data);
                container.innerHTML = '<div class="no-data">No data</div>';
                return;
            }
            
            console.log('Pie chart data rows:', data.rows);
            
            // Create canvas
            container.innerHTML = `<canvas id="${canvasId}" style="width: 100%; height: 250px;"></canvas>`;
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.log('Canvas not found', canvasId);
                return;
            }
            
            const labels = data.rows.map(row => String(row[0] || 'Unknown'));
            const values = data.rows.map(row => row[1] || 0);
            const colors = data.rows.map((_, i) => chartColors[i % chartColors.length]);
            
            const ctx = canvas.getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderColor: '#1a1a24',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#94a3b8',
                                font: { size: 11 },
                                padding: 10,
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const value = context.raw;
                                    const percent = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toLocaleString()} (${percent}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Initialize Bar Chart with Chart.js
        function initBarChart(card, idx, displayType) {
            const canvasId = `bar-chart-${idx}-${Date.now()}`;
            const container = document.querySelector(`[data-card-index="${idx}"] .chart-container`);
            if (!container) return;
            
            const data = card.data;
            if (!data || !data.rows || data.rows.length === 0) {
                container.innerHTML = '<div class="no-data">No data</div>';
                return;
            }
            
            // Create canvas
            container.innerHTML = `<canvas id="${canvasId}"></canvas>`;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            // Limit to top 15 items for readability
            const sortedRows = [...data.rows].sort((a, b) => (b[1] || 0) - (a[1] || 0)).slice(0, 15);
            const labels = sortedRows.map(row => String(row[0] || 'Unknown'));
            const values = sortedRows.map(row => row[1] || 0);
            
            const ctx = canvas.getContext('2d');
            const isHorizontal = displayType === 'row';
            
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: chartColors[0],
                        borderColor: chartColors[0],
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: isHorizontal ? 'y' : 'x',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.raw.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: '#94a3b8',
                                font: { size: 10 },
                                maxRotation: 45
                            }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { 
                                color: '#94a3b8',
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }
        
        // Initialize Line Chart with Chart.js
        function initLineChart(card, idx) {
            const canvasId = `line-chart-${idx}-${Date.now()}`;
            const container = document.querySelector(`[data-card-index="${idx}"] .chart-container`);
            if (!container) return;
            
            const data = card.data;
            if (!data || !data.rows || data.rows.length === 0) {
                container.innerHTML = '<div class="no-data">No data</div>';
                return;
            }
            
            // Create canvas
            container.innerHTML = `<canvas id="${canvasId}"></canvas>`;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const labels = data.rows.map(row => String(row[0] || ''));
            const values = data.rows.map(row => row[1] || 0);
            
            const ctx = canvas.getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        borderColor: chartColors[0],
                        backgroundColor: chartColors[0] + '33',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointBackgroundColor: chartColors[0]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        }
                    }
                }
            });
        }
        
        // Render table data
        function renderMergedTable(data, cardIdx) {
            if (!data || !data.rows || data.rows.length === 0) {
                return '<div class="no-data">No data</div>';
            }
            
            const cols = data.cols || [];
            const rows = data.rows.slice(0, 100); // Limit to 100 rows for display
            const hasMore = data.rows.length > 100;
            const card = window.mergedCardsData ? window.mergedCardsData[cardIdx] : null;
            const hasClickBehavior = card && card.click_behavior && card.click_behavior.type;
            
            let html = '<div class="table-container"><table class="merged-card-table"><thead><tr>';
            
            // Headers
            if (cols.length > 0) {
                cols.forEach(col => {
                    html += `<th>${escapeHtml(col.display_name || col.name || 'Column')}</th>`;
                });
            } else if (rows.length > 0) {
                // Generate generic headers if cols not provided
                rows[0].forEach((_, i) => {
                    html += `<th>Column ${i + 1}</th>`;
                });
            }
            html += '</tr></thead><tbody>';
            
            // Rows
            rows.forEach((row, rowIdx) => {
                const rowClass = hasClickBehavior ? 'clickable-row' : '';
                const rowClick = hasClickBehavior ? `onclick="handleTableRowClick(${cardIdx}, ${rowIdx}, event)"` : '';
                html += `<tr class="${rowClass}" ${rowClick}>`;
                row.forEach((cell, colIdx) => {
                    let value = cell === null ? '' : cell;
                    // Format numbers
                    if (typeof value === 'number') {
                        value = value.toLocaleString();
                    }
                    // Truncate long strings
                    if (typeof value === 'string' && value.length > 50) {
                        value = `<span title="${escapeHtml(cell)}">${escapeHtml(value.substring(0, 47))}...</span>`;
                    } else {
                        value = escapeHtml(String(value));
                    }
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            if (hasMore) {
                html += `<div class="table-footer">Showing 100 of ${data.rows.length.toLocaleString()} rows</div>`;
            }
            
            return html;
        }
        
        // Handle table row click
        function handleTableRowClick(cardIdx, rowIdx, event) {
            event.stopPropagation();
            const card = window.mergedCardsData[cardIdx];
            if (!card || !card.data || !card.data.rows) return;
            
            const row = card.data.rows[rowIdx];
            const cols = card.data.cols || [];
            
            // Build row data object
            const rowData = {};
            cols.forEach((col, i) => {
                rowData[col.name || col.display_name || `col${i}`] = row[i];
            });
            
            console.log('Table row clicked:', rowData);
            showRowDetailModal(card, rowData, cols, row);
        }
        
        // Show row detail modal
        function showRowDetailModal(card, rowData, cols, row) {
            let modal = document.getElementById('drilldown-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'drilldown-modal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h2 id="drilldown-title">Row Details</h2>
                            <button class="close-btn" onclick="closeDrillDownModal()">&times;</button>
                        </div>
                        <div class="modal-body" id="drilldown-body"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            const titleEl = document.getElementById('drilldown-title');
            const bodyEl = document.getElementById('drilldown-body');
            
            titleEl.textContent = `${card.name || 'Row'} - Details`;
            
            let content = '<div class="row-details">';
            cols.forEach((col, i) => {
                const colName = col.display_name || col.name || `Column ${i + 1}`;
                const value = row[i];
                content += `
                    <div class="detail-row">
                        <span class="detail-label">${escapeHtml(colName)}</span>
                        <span class="detail-value">${formatCellValue(value)}</span>
                    </div>
                `;
            });
            content += '</div>';
            
            bodyEl.innerHTML = content;
            modal.classList.add('active');
        }
        
        // Close merged dashboard viewer
        function closeMergedViewer() {
            const modal = document.getElementById('merged-viewer-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            
            // Cleanup chart instances
            Object.values(chartInstances).forEach(chart => {
                try { chart.destroy(); } catch(e) {}
            });
            chartInstances = {};
            
            currentMergedDashboard = null;
            currentMergedTabId = null;
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDashboardsModal();
            }
        });

        // ========== END DASHBOARD MODAL FUNCTIONS ==========

        // Render logs with current filter
        function renderLogs() {
            const logList = document.getElementById('log-list');
            let filteredEntries = filterEntries(allLogEntries);
            
            // Sort by timestamp descending (newest first) - handle both Z and non-Z formats
            filteredEntries.sort((a, b) => {
                const dateA = new Date(a.timestamp);
                const dateB = new Date(b.timestamp);
                return dateB - dateA;
            });
            
            document.getElementById('log-count').textContent = `${filteredEntries.length} of ${totalLogCount} entries`;
            
            if (filteredEntries.length === 0) {
                logList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p>No dashboards found for selected filter</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Try a different date range</p>
                    </div>
                `;
                return;
            }
            
            logList.innerHTML = filteredEntries.map(entry => `
                <div class="log-entry ${entry.status === 'deleted' ? 'deleted' : ''}">
                    <span class="log-type ${entry.db_type}">${entry.db_type}</span>
                    <div class="log-info">
                        <div class="log-dashboard">${entry.dashboard_name}</div>
                        <div class="log-database">${entry.status === 'deleted' ? 'Database decomposed' : `Database: ${entry.database_name} (ID: ${entry.database_id})`}</div>
                        ${entry.performed_by ? `<div class="log-performer" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                            By: ${entry.performed_by === 'auto-clone' ? 'ðŸ¤– Auto-Clone' : (entry.performed_by === 'manual-run' ? 'ðŸ‘¤ Manual Run' : `ðŸ‘¤ ${entry.performed_by}`)}
                        </div>` : ''}
                    </div>
                    <div class="log-time">${formatTimestamp(entry.timestamp)}</div>
                    <div class="log-status">
                        <span class="status-icon ${entry.status}">
                            ${entry.status === 'success' ? 'âœ“' : (entry.status === 'deleted' ? 'ðŸ—‘' : (entry.status === 'updated' ? 'ðŸ”„' : (entry.status === 'renamed' ? 'âœï¸' : 'âœ—')))}
                        </span>
                        ${entry.status === 'success' && entry.dashboard_url ? 
                            `<a href="${entry.dashboard_url}" target="_blank" class="log-link">Open â†’</a>` : 
                            (entry.status === 'updated' && entry.dashboard_url ? 
                            `<a href="${entry.dashboard_url}" target="_blank" class="log-link">Open â†’</a>` :
                            (entry.status === 'renamed' && entry.dashboard_url ? 
                            `<a href="${entry.dashboard_url}" target="_blank" class="log-link">Open â†’</a>` :
                            (entry.status === 'deleted' ? '<span style="color: #fbbf24; font-size: 0.8rem;">Deleted</span>' :
                            (entry.error_message ? `<span style="color: var(--accent-red); font-size: 0.8rem;">${entry.error_message}</span>` : ''))))
                        }
                    </div>
                </div>
            `).join('');
        }

        // Update countdown display
        function updateCountdown() {
            if (secondsRemaining > 0) {
                secondsRemaining--;
                document.getElementById('countdown').textContent = formatTime(secondsRemaining);
            }
        }

        // Fetch status
        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                secondsRemaining = data.seconds_until_next;
                document.getElementById('countdown').textContent = formatTime(secondsRemaining);
                
                const statusBadge = document.getElementById('status-badge');
                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                const countdown = document.getElementById('countdown');
                const runBtn = document.getElementById('run-btn');
                const stopBtn = document.getElementById('stop-btn');
                
                if (data.is_running) {
                    statusBadge.classList.add('running');
                    statusDot.classList.add('active');
                    countdown.classList.add('running');
                    runBtn.disabled = true;
                    runBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-flex';
                    
                    // If stop was requested, disable stop button and show stopping state
                    if (data.stop_requested) {
                        stopBtn.disabled = true;
                        stopBtn.innerHTML = `
                            <svg class="spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12a9 9 0 11-6.219-8.56"></path>
                            </svg>
                            Stopping...
                        `;
                    } else {
                        stopBtn.disabled = false;
                        stopBtn.innerHTML = `
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                            </svg>
                            Stop
                        `;
                    }
                } else {
                    statusBadge.classList.remove('running');
                    statusDot.classList.remove('active');
                    countdown.classList.remove('running');
                    runBtn.disabled = false;
                    runBtn.style.display = 'inline-flex';
                    stopBtn.style.display = 'none';
                }
                
                statusText.textContent = data.current_status;
                
            } catch (error) {
                console.error('Failed to fetch status:', error);
            }
        }

        // Fetch dashboard counts from _DASHBOARDS collections
        async function fetchDashboardCounts() {
            try {
                const response = await fetch('/api/dashboard-counts');
                const data = await response.json();
                
                if (!data.error) {
                    // Update stats cards with actual dashboard counts
                    document.getElementById('stat-total').textContent = data.total;
                    document.getElementById('stat-content').textContent = data.content;
                    document.getElementById('stat-message').textContent = data.message;
                    document.getElementById('stat-email').textContent = data.email;
                }
            } catch (error) {
                console.error('Failed to fetch dashboard counts:', error);
            }
        }
        
        // Fetch logs
        let totalLogCount = 0;  // Track total count from server
        
        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();
                
                // Store all entries for filtering
                allLogEntries = data.entries;
                totalLogCount = data.total_count || data.entries.length;
                
                // Render with current filter
                renderLogs();
                
            } catch (error) {
                console.error('Failed to fetch logs:', error);
            }
        }

        // Fetch config
        async function fetchConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                
                const setConfigValue = (id, value) => {
                    const el = document.getElementById(id);
                    if (value) {
                        el.textContent = `Source: ${value}`;
                        el.classList.remove('not-set');
                    } else {
                        el.textContent = 'Not configured';
                        el.classList.add('not-set');
                    }
                };
                
                setConfigValue('config-content', data.source_dashboards?.content);
                setConfigValue('config-message', data.source_dashboards?.message);
                setConfigValue('config-email', data.source_dashboards?.email);
                
            } catch (error) {
                console.error('Failed to fetch config:', error);
            }
        }

        // Trigger manual run
        async function triggerRun() {
            try {
                const btn = document.getElementById('run-btn');
                btn.disabled = true;
                
                const response = await fetch('/api/run', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    // Start polling for updates
                    setTimeout(refreshData, 1000);
                } else {
                    alert(data.error || 'Failed to start check');
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Failed to trigger run:', error);
                alert('Failed to start check');
            }
        }

        // Stop the current run
        async function stopRun() {
            try {
                const btn = document.getElementById('stop-btn');
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12a9 9 0 11-6.219-8.56"></path>
                    </svg>
                    Stopping...
                `;
                
                const response = await fetch('/api/stop', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    // Refresh to show updated status
                    setTimeout(refreshData, 500);
                } else {
                    alert(data.error || 'Failed to stop');
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                        </svg>
                        Stop
                    `;
                }
            } catch (error) {
                console.error('Failed to stop run:', error);
                alert('Failed to stop');
            }
        }

        // Refresh all data
        function refreshData() {
            fetchStatus();
            fetchLogs();
            fetchConfig();
            fetchDashboardCounts();
            checkMongoDBStatus();
            loadMergedDashboards();
        }

        // Check MongoDB connection status
        async function checkMongoDBStatus() {
            try {
                const response = await fetch('/api/mongodb-status');
                const data = await response.json();
                
                const statusEl = document.getElementById('mongodb-status');
                const textEl = document.getElementById('mongodb-text');
                
                if (data.connected) {
                    statusEl.className = 'mongodb-status connected';
                    textEl.textContent = 'MongoDB Connected';
                } else {
                    statusEl.className = 'mongodb-status disconnected';
                    textEl.textContent = 'MongoDB Disconnected';
                }
            } catch (error) {
                console.error('Failed to check MongoDB status:', error);
                const statusEl = document.getElementById('mongodb-status');
                const textEl = document.getElementById('mongodb-text');
                statusEl.className = 'mongodb-status disconnected';
                textEl.textContent = 'MongoDB Error';
            }
        }

        // =====================
        // Settings Modal
        // =====================
        
        function openSettings() {
            document.getElementById('settings-modal').classList.add('active');
            loadSettings();
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const data = await response.json();
                
                // Populate Metabase credentials
                document.getElementById('metabase-url').value = data.metabase?.base_url || '';
                document.getElementById('metabase-username').value = data.metabase?.username || '';
                document.getElementById('metabase-password').value = data.metabase?.password || '';
                
                // Populate source dashboards
                document.getElementById('source-content').value = data.source_dashboards?.content || '';
                document.getElementById('source-message').value = data.source_dashboards?.message || '';
                document.getElementById('source-email').value = data.source_dashboards?.email || '';
                
                // Populate collections
                document.getElementById('collection-content').value = data.dashboards_collections?.content || '';
                document.getElementById('collection-message').value = data.dashboards_collections?.message || '';
                document.getElementById('collection-email').value = data.dashboards_collections?.email || '';
            } catch (error) {
                console.error('Failed to load settings:', error);
                showToast('Failed to load settings', 'error');
            }
        }

        async function saveSettings() {
            const saveBtn = document.getElementById('save-settings-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<svg class="spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"></path></svg> Saving...';
            
            try {
                const settings = {
                    metabase: {
                        base_url: document.getElementById('metabase-url').value.trim(),
                        username: document.getElementById('metabase-username').value.trim(),
                        password: document.getElementById('metabase-password').value
                    },
                    source_dashboards: {
                        content: parseInt(document.getElementById('source-content').value) || null,
                        message: parseInt(document.getElementById('source-message').value) || null,
                        email: parseInt(document.getElementById('source-email').value) || null
                    },
                    dashboards_collections: {
                        content: parseInt(document.getElementById('collection-content').value) || null,
                        message: parseInt(document.getElementById('collection-message').value) || null,
                        email: parseInt(document.getElementById('collection-email').value) || null
                    }
                };
                
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Settings saved successfully!', 'success');
                    closeSettings();
                    fetchConfig(); // Refresh the config display
                } else {
                    showToast(data.error || 'Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                showToast('Failed to save settings', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg> Save Settings';
            }
        }

        async function testConnection() {
            const testBtn = document.getElementById('test-connection-btn');
            testBtn.disabled = true;
            testBtn.innerHTML = '<svg class="spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"></path></svg> Testing...';
            
            try {
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        base_url: document.getElementById('metabase-url').value.trim(),
                        username: document.getElementById('metabase-username').value.trim(),
                        password: document.getElementById('metabase-password').value
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Connection successful!', 'success');
                } else {
                    showToast(data.error || 'Connection failed', 'error');
                }
            } catch (error) {
                console.error('Connection test failed:', error);
                showToast('Connection test failed', 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg> Test Connection';
            }
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Close modal on overlay click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeSettings();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSettings();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication first
            await checkAuthStatus();
            
            // Only start data refresh if authenticated (or auth not configured)
            const mainContent = document.getElementById('main-content');
            if (!mainContent.classList.contains('hidden')) {
                refreshData();
                
                // Update countdown every second
                countdownInterval = setInterval(updateCountdown, 1000);
                
                // Refresh data every 5 seconds
                setInterval(refreshData, 5000);
            }
        });
    </script>
    </div> <!-- End of main-content -->

    <!-- Merged Dashboard Viewer Modal -->
    <div id="merged-viewer-modal" class="merged-viewer-modal">
        <div class="merged-viewer-header">
            <div style="display: flex; align-items: center; gap: 2rem;">
                <div>
                    <div class="merged-viewer-title" id="merged-viewer-title">Merged Dashboard</div>
                    <div class="merged-viewer-meta" id="merged-viewer-meta">Loading...</div>
                </div>
                <!-- Filters Section -->
                <div class="merged-filters" id="merged-filters" style="display: none;">
                    <!-- Filters will be rendered here -->
                </div>
            </div>
            <button class="merged-viewer-close" onclick="closeMergedViewer()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back
            </button>
        </div>
        <!-- Tabs Navigation -->
        <div class="merged-tabs" id="merged-tabs" style="display: none;">
            <!-- Tabs will be rendered here -->
        </div>
        <div class="merged-viewer-body">
            <div class="merged-cards-grid" id="merged-cards-grid">
                <div class="merged-card-loading">Loading dashboard data...</div>
            </div>
        </div>
    </div>
    
    <style>
        /* Merged Dashboard Tabs */
        .merged-tabs {
            display: flex;
            gap: 0;
            padding: 0 2rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        .merged-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .merged-tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }
        .merged-tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }
        
        /* Filters */
        .merged-filters {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .merged-filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .merged-filter-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .merged-filter-select {
            padding: 0.4rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            min-width: 120px;
        }
        .merged-filter-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        
        /* Improved card grid with proper sizing - Metabase uses 24 columns */
        .merged-cards-grid {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 1rem;
            padding: 1.5rem 2rem;
            align-items: start;
        }
        
        .merged-card {
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .merged-card-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
        }
        
        .merged-card-title {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
        }
        
        .merged-card-type {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        .merged-card-body {
            flex: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 150px;
        }
        
        /* Scalar/Number cards */
        .merged-card-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-blue);
            text-align: center;
        }
        .merged-card-value.small {
            font-size: 1.8rem;
        }
        
        /* Chart containers */
        .chart-container {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 200px;
        }
        .chart-container canvas {
            max-width: 100%;
            max-height: 300px;
        }
        
        /* Table styling */
        .table-container {
            overflow-x: auto;
            max-height: 350px;
            overflow-y: auto;
        }
        .merged-card-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        .merged-card-table th {
            background: var(--bg-secondary);
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .merged-card-table td {
            padding: 0.4rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .merged-card-table tr:hover td {
            background: var(--bg-hover);
        }
        .table-footer {
            text-align: center;
            padding: 0.5rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            background: var(--bg-secondary);
        }
        
        /* Click behavior styles */
        .has-click-behavior, .clickable-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .has-click-behavior:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }
        .clickable-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(255, 255, 255, 0.1);
        }
        .merged-card-value.clickable {
            cursor: pointer;
        }
        .merged-card-value.clickable:hover {
            color: #60a5fa;
        }
        .clickable-row {
            cursor: pointer;
        }
        .clickable-row:hover td {
            background: rgba(59, 130, 246, 0.1) !important;
        }
        
        /* Drilldown modal styles */
        #drilldown-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 2rem;
        }
        #drilldown-modal.active {
            display: flex;
        }
        #drilldown-modal .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 100%;
            max-width: 900px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        #drilldown-modal .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 1;
        }
        #drilldown-modal .modal-header h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        #drilldown-modal .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            line-height: 1;
        }
        #drilldown-modal .close-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        #drilldown-modal .modal-body {
            padding: 1.5rem;
        }
        .drilldown-info {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 3px solid var(--accent-blue);
        }
        .drilldown-info p {
            margin: 0.25rem 0;
        }
        .drilldown-section {
            margin-bottom: 1.5rem;
        }
        .drilldown-section h3 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .source-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .source-list li {
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            margin-bottom: 0.25rem;
            border-radius: 4px;
        }
        .row-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
        }
        
        /* Drill-through specific styles */
        .drill-breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .breadcrumb-item {
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .breadcrumb-item:hover:not(.active) {
            background: var(--bg-hover);
            color: var(--accent-blue);
        }
        .breadcrumb-item.active {
            color: var(--text-primary);
            font-weight: 500;
            cursor: default;
        }
        .breadcrumb-separator {
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        
        .drill-type-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            background: var(--accent-blue);
            color: white;
            border-radius: 4px;
            text-transform: uppercase;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        
        .drill-filters-applied {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .filter-tag {
            background: var(--accent-blue);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            font-size: 0.8rem;
        }
        
        .drill-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .drill-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s;
        }
        .drill-card.has-click-behavior {
            cursor: pointer;
        }
        .drill-card.has-click-behavior:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }
        
        .drill-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
        }
        .drill-card-title {
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
        }
        .drill-card-type {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .drill-card-body {
            padding: 1rem;
            min-height: 100px;
        }
        
        .drill-scalar-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
            text-align: center;
            padding: 1rem;
        }
        
        .drill-chart-container {
            height: 200px;
            position: relative;
        }
        
        .drill-table-container {
            max-height: 300px;
            overflow: auto;
        }
        .drill-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        .drill-table th {
            background: var(--bg-card);
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
        }
        .drill-table td {
            padding: 0.4rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .drill-table tr:hover td {
            background: var(--bg-hover);
        }
        
        .drill-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            gap: 1rem;
        }
        .drill-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .drill-error {
            padding: 2rem;
            text-align: center;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 6px;
        }
        .detail-label {
            color: var(--text-secondary);
            font-weight: 500;
        }
        .detail-value {
            color: var(--text-primary);
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }
        .null-value {
            color: var(--text-muted);
            font-style: italic;
        }
        .merged-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .merged-table th {
            background: var(--bg-tertiary);
            padding: 0.6rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
        }
        .merged-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .merged-table tr:hover td {
            background: var(--bg-hover);
        }
        
        /* Bar/Row chart list style */
        .bar-chart-list {
            padding: 0.5rem 0;
        }
        .bar-chart-item {
            margin-bottom: 0.75rem;
        }
        .bar-chart-label-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }
        .bar-chart-label {
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
        }
        .bar-chart-value {
            color: var(--text-primary);
            font-weight: 600;
        }
        .bar-chart-bar {
            background: var(--bg-secondary);
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
        }
        .bar-chart-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        /* Source breakdown popup */
        .source-breakdown {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 100;
            min-width: 200px;
        }
        .source-breakdown-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }
        .source-breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            font-size: 0.85rem;
        }
        .source-breakdown-name {
            color: var(--text-secondary);
        }
        .source-breakdown-value {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        /* Loading state */
        .merged-card-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 150px;
            color: var(--text-muted);
        }
        
        /* No data state */
        .no-data {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
    </style>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Settings
                </h2>
                <button class="modal-close" onclick="closeSettings()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Metabase Credentials -->
                <div class="settings-section">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        Metabase Connection
                    </h3>
                    <div class="form-group">
                        <label for="metabase-url">Metabase URL</label>
                        <input type="url" id="metabase-url" class="form-input" placeholder="https://your-metabase.com">
                    </div>
                    <div class="form-group">
                        <label for="metabase-username">Username / Email</label>
                        <input type="text" id="metabase-username" class="form-input" placeholder="admin@example.com">
                    </div>
                    <div class="form-group">
                        <label for="metabase-password">Password</label>
                        <input type="password" id="metabase-password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                    </div>
                </div>

                <!-- Source Dashboards -->
                <div class="settings-section">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="3" y1="9" x2="21" y2="9"></line>
                            <line x1="9" y1="21" x2="9" y2="9"></line>
                        </svg>
                        Source Dashboard IDs (Templates to Clone)
                    </h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="source-content">Content</label>
                            <input type="number" id="source-content" class="form-input" placeholder="Dashboard ID">
                        </div>
                        <div class="form-group">
                            <label for="source-message">Message</label>
                            <input type="number" id="source-message" class="form-input" placeholder="Dashboard ID">
                        </div>
                        <div class="form-group">
                            <label for="source-email">Email</label>
                            <input type="number" id="source-email" class="form-input" placeholder="Dashboard ID">
                        </div>
                    </div>
                </div>

                <!-- Dashboards Collections -->
                <div class="settings-section">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        </svg>
                        _DASHBOARDS Collection IDs (Where to Store)
                    </h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="collection-content">Content</label>
                            <input type="number" id="collection-content" class="form-input" placeholder="Collection ID">
                        </div>
                        <div class="form-group">
                            <label for="collection-message">Message</label>
                            <input type="number" id="collection-message" class="form-input" placeholder="Collection ID">
                        </div>
                        <div class="form-group">
                            <label for="collection-email">Email</label>
                            <input type="number" id="collection-email" class="form-input" placeholder="Collection ID">
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="test-btn" id="test-connection-btn" onclick="testConnection()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    Test Connection
                </button>
                <button class="save-btn" id="save-settings-btn" onclick="saveSettings()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>
</body>
</html>
